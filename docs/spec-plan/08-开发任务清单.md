# OKSAI SAAS 服务端框架 - 第一阶段开发任务清单（持续开发指引）

**版本**: 1.3.0
**创建日期**: 2026-02-08
**最后更新日期**: 2026-02-08
**文档类型**: 开发任务清单
**状态**: 进行中（持续更新）

---

## 0. 已完成任务

### 0-1 构建系统修复

-   **完成时间**: 2026-02-08
-   **证据**: （建议填写 commit hash 或 PR 链接）
-   **完成内容**:
    -   修复 `prometheus.controller.ts` 中的重复方法定义
    -   修复 `core.module.ts` 中缺少的闭合括号
    -   移除 `libs/core/src/index.ts` 中的重复导出
    -   添加 `BaseEntity` 和 `CoreModule` 的正确导出
    -   修复 `correlation-id.middleware.ts` 中的 uuid 导入（从 `crypto` 改为 `uuid`）
    -   从 `@oksai/core` 包添加 `RequestMetric` 和 `PerformanceSummary` 导出
    -   修复所有包的类型定义和导出
-   **验收标准**: ✅ 所有 20 个包均成功编译构建

### 0-2 多租户隔离优化

-   **完成时间**: 2026-02-08
-   **证据**:
    -   `libs/core/src/lib/context/request-context.service.ts`
    -   `libs/core/src/lib/context/request-context.middleware.ts`
    -   `libs/core/src/lib/guards/tenant.guard.ts`
    -   `libs/user/src/lib/user.service.ts`
-   **完成内容**:
    -   ✅ `TenantGuard` 改为使用 `RequestContext.getCurrentTenantId()` 而不是直接检查 `request.user.tenantId`
    -   ✅ `UserService` 重构：所有方法移除 `currentTenantId` 参数，改用 `RequestContext.getCurrentTenantId()`
    -   🟡 `UserController` 待移除 `@Req()` 与 tenantId 兜底逻辑，避免控制器层手工传递租户上下文
    -   ✅ 确保 `tenantId` 无法被客户端参数覆盖
    -   ✅ 所有包成功构建，无类型错误
-   **验收标准**: ✅ 租户上下文统一使用 RequestContext，客户端无法覆盖服务端 tenantId

---

## 1. 目标对齐（必须遵守）

本任务清单严格对齐 `.cursor/rules/AGENTS.md:19-41` 第一阶段目标：

-   **认证删减**：仅保留 Google、Microsoft、GitHub、Auth0。
-   **ORM 简化**：仅使用 MikroORM，移除 TypeORM 与多 ORM 抽象层。
-   **数据库模型简化**：默认 PostgreSQL，后续扩展 MongoDB、Better-SQLite。
-   **插件系统保留**：系统插件（必备）+ 业务插件（可选），支持热拔插。
-   **通用能力**：认证授权、多租户、权限、审计、配置、监控、日志。
-   **结构对齐与复用**：对齐 `qauzy-backup` 的代码组织结构，优先复用旧实现，避免重复造轮子。

---

## 2. 当前现状快照（以代码为准）

-   **构建系统**：✅ 所有包（20 个）均可成功构建，无类型错误
-   **认证**：`libs/auth` 已实现 Google/Microsoft/GitHub/Auth0 的策略与回调控制器
-   **OAuth 统一回调**：✅ `UnifiedOAuthCallbackController` 和 `UnifiedOAuthCallbackService` 已实现，提供统一的 OAuth 处理链路
-   **ORM**：`apps/base-api` 与 `libs/*` 已以 MikroORM 为主（PG 驱动优先）
-   **核心实体**：以 `03-核心实体清单.md` 的 17 个实体为范围
-   **插件系统**：`libs/plugin` 已提供插件管理 API（查询/启用/禁用/重载/卸载）与基础注册/加载能力
-   **请求上下文**：✅ `RequestContext` 和 `RequestContextMiddleware` 已基于 `nestjs-cls` 实现
-   **租户守卫**：✅ `TenantGuard` 已实现，统一使用 RequestContext 获取租户 ID
-   **监控指标**：✅ `MetricsService` 和 `PrometheusController` 已实现，提供性能指标端点
-   **多租户隔离**：🟡 RequestContext + TenantGuard + UserService 已迁移；Controller 层迁移与跨租户验收仍需补齐
-   **测试**：已存在单元测试与 E2E 骨架，但覆盖率目标（80%+/90%）仍需持续补齐

---

## 3. 任务清单（按优先级推进）

说明：P0 必须先闭环；P1/P2 在 P0 稳定后并行推进。每个任务都给出**验收标准**，用于评测是否达成项目目标。

### P0（必须闭环）

#### P0-1 多租户隔离闭环（RequestContext/租户上下文/数据过滤）

**状态**: 🟡 进行中（基础设施已完成，闭环验收待补齐）
**完成时间**: 2026-02-08（基础设施）

-   **目标**：将"租户上下文"从"控制器手工传参/兜底 default"升级为**统一的请求上下文**，并在数据访问层统一追加 tenant 过滤，避免跨租户数据泄露。
-   **参考复用点**：`qauzy-backup/packages/core/src/lib/core/context/request-context.ts` + `request-context.middleware.ts`（基于 `nestjs-cls`）。
-   **已完成**:
    -   ✅ `RequestContext` 基于 `nestjs-cls` 实现
    -   ✅ `RequestContextMiddleware` 自动初始化请求上下文
    -   ✅ `TenantGuard` 改为使用 `RequestContext.getCurrentTenantId()` 获取租户上下文
    -   🟡 `AuthGuard`/认证链路设置 `RequestContext.setCurrentUser()` 的实现位置需补充证据或补实现
    -   ✅ `UserService` 重构：移除 `currentTenantId` 参数，所有方法从 RequestContext 获取租户 ID
    -   🟡 `UserController` 待完成迁移：移除 `@Req()` 装饰器与 tenantId 兜底逻辑
    -   ✅ 确保 `tenantId` 无法被客户端参数覆盖
    -   ✅ 所有包成功构建，无类型错误
-   **验收标准**:
    -   🟡 **跨租户读**：tenantA 的 token 无法读取 tenantB 数据（返回 403/404，但不得泄露）。
    -   🟡 **跨租户写**：客户端传入 tenantId 不能覆盖服务端上下文 tenantId。
    -   ✅ **无租户**：缺失 tenantId 的受保护请求一律拒绝（403）。

#### P0-2 插件"热拔插"语义闭环（模块/路由/资源释放）

**状态**: 🟡 进行中（基础 API 已实现，需完善热拔插语义）

-   **目标**：明确插件是"对象插件"还是"模块插件"，并保证 enable/disable/reload/unload 的行为符合"热拔插"定义（至少对业务插件成立）。
-   **参考复用点**：`qauzy-backup/packages/plugin` 的 plugin metadata 聚合（entities/subscribers/configuration）与 bootstrap 冲突检测。
-   **已完成**:
    -   ✅ `PluginRegistryService` 插件注册与查询
    -   ✅ `PluginLoaderService` 插件加载与配置管理
    -   ✅ `PluginController` 提供 CRUD 端点
    -   ✅ 插件状态管理（enabled/disabled）
-   **待完善**:
    -   实现模块级别的热加载/卸载
    -   添加插件冲突检测机制
    -   确保系统插件（auth、tenant、user 等）不可被禁用/卸载
    -   验证 enable/disable 后路由实际生效/失效
    -   检测并防止内存泄漏
-   **验收标准**：
    -   `POST /api/plugins/:name/disable` 后，该插件提供的路由与行为不再生效（或明确返回禁用状态）。
    -   `POST /api/plugins/:name/reload` 后，插件配置变更生效且无内存泄漏/重复注册。
    -   系统插件保持"受保护，不可禁用/卸载"。

#### P0-3 OAuth 回调统一处理链路（减少分叉）

**状态**: 🟡 进行中（统一回调服务已实现，需测试验证）

-   **目标**：各 OAuth Provider 回调统一进入同一条"验证邮件 → 生成登录态 → 重定向/返回 token"的链路，减少策略分叉导致的安全与一致性风险。
-   **参考复用点**：`qauzy-backup/packages/auth` 的 `SocialAuthService.validateOAuthLoginEmail()` + `routeRedirect()` 结构。
-   **已完成**:
    -   ✅ `UnifiedOAuthCallbackService` 统一处理 4 个 OAuth Provider 的回调
    -   ✅ `UnifiedOAuthCallbackController` 提供 4 个统一的回调端点
    -   ✅ 一致的错误处理和响应结构
    -   ✅ 不记录敏感信息（token/密码）
-   **待验证**:
    -   测试所有 4 个 Provider 的实际回调流程
    -   验证重定向 URL 生成逻辑
    -   确认用户创建和 JWT 生成正确
    -   验证失败重定向到注册页面的逻辑
-   **验收标准**：
    -   4 家 OAuth 回调行为一致（成功/失败响应结构一致）。
    -   回调中不记录敏感信息（token/密码）。

### P1（重要优化）

#### P1-1 测试策略落地（覆盖率与关键路径）

**状态**: 🔴 待开始

-   **目标**：达到项目宪章的测试要求：核心逻辑 80%+，关键路径 90%+。
-   **建议路径**：
    -   单元测试：services、guards、plugin loader/registry、关键业务分支。
    -   E2E：认证、租户隔离、权限校验、插件启停、审计记录、监控端点。
-   **验收标准**：
    -   `pnpm test` 通过；覆盖率报告达到目标（按包统计）。

#### P1-2 监控/日志/审计的"可验证性"

**状态**: 🟡 进行中（监控服务已实现，需验证集成）

-   **目标**：把"有实现"升级为"可验证"：指标端点、日志关联 ID、审计记录可查询。
-   **已完成**:
    -   ✅ `MetricsService` 记录请求指标
    -   ✅ `PrometheusController` 提供指标查询端点
    -   ✅ `CorrelationIdMiddleware` 为每个请求生成关联 ID（实现位于 `@oksai/core`）
-   **待验证**:
    -   验证指标端点可访问且返回正确数据
    -   确认日志中包含 correlationId
    -   验证审计记录在写操作时正确生成
    -   检查错误追踪与指标记录的关联
-   **验收标准**：
    -   Prometheus 指标端点可用（路径以实现为准）。
    -   请求日志带 `x-correlation-id` 并贯穿错误追踪与指标记录。
    -   关键写操作产生审计记录（AuditLog）。

### P2（演进与体验）

#### P2-1 文档与代码同步机制

**状态**: 🟡 进行中

-   **目标**：持续保持 spec-plan 与实现一致，避免"文档失真"影响评测。
-   **已完成**:
    -   ✅ 定期更新任务清单状态
    -   ✅ 跟踪已完成的功能
-   **验收标准**：
    -   变更实体/插件/API 时，同步更新 `03/04/05` 与 `06/07`。

---

## 4. 验收用例清单（可直接转为 E2E）

### 4.1 插件系统

-   `GET /api/plugins`：返回插件列表与状态。
-   `POST /api/plugins/:name/disable`：
    -   系统插件：应失败（受保护）。
    -   业务插件：应成功并可观察到行为变化。
-   `POST /api/plugins/:name/reload`：配置变更生效。

### 4.2 多租户隔离

-   缺失 tenantId 的受保护请求 → 403。
-   tenantA token 访问 tenantB 数据 → 403/404（不泄露）。
-   创建/更新资源时 tenantId 必须来自上下文（不可被客户端覆盖）。

### 4.3 权限管理

-   无权限访问写接口 → 403。
-   同租户不同角色权限差异可验证。

### 4.4 审计/监控/日志

-   写操作后 audit log 可查询到对应记录（tenantId/userId/action/entityId）。
-   指标端点可拉取、日志携带 correlationId。

---

## 5. 推荐命令（开发常用）

```bash
# 启动 base-api
cd apps/base-api && pnpm run start:dev

# 构建
pnpm run build

# Lint
pnpm run turbo:lint

# 类型检查
pnpm run typecheck

# 测试
pnpm test
```

---

**文档结束**
