# OKSAI SAAS 服务端框架 - 技术规格文档

**版本**: 1.0.0
**创建日期**: 2026-02-07
**文档类型**: 技术规格
**状态**: 待实施

---

## 文档概述

本文档详细描述 OKSAI SAAS 服务端框架的第一阶段技术规格，包括架构设计、技术栈、数据库设计、插件系统、认证系统等核心技术组件。

---

## 目录

1. [项目概述](#1-项目概述)
2. [技术架构](#2-技术架构)
3. [技术栈](#3-技术栈)
4. [数据库设计](#4-数据库设计)
5. [插件系统架构](#5-插件系统架构)
6. [认证系统](#6-认证系统)
7. [多租户架构](#7-多租户架构)
8. [API 设计](#8-api-设计)
9. [安全性](#9-安全性)
10. [性能优化](#10-性能优化)

---

## 1. 项目概述

### 1.1 项目目标

构建一个轻量、可扩展的多租户 SAAS 服务端框架，核心特点：

-   **插件化架构**: 支持系统插件和业务插件，实现热拔插
-   **多租户支持**: 完整的租户隔离机制
-   **简化的 ORM**: 只使用 MikroORM，移除 TypeORM 和多 ORM 抽象层
-   **第三方认证**: 支持 Google、Microsoft、GitHub、Auth0
-   **高可测试性**: 完整的单元测试、集成测试、E2E 测试

### 1.2 项目范围

#### 第一阶段范围

-   ✅ 核心基础框架（认证、租户、用户、组织、权限）
-   ✅ 插件系统（分类管理、热拔插）
-   ✅ 基础实体（约 10-15 个核心实体）
-   ✅ 完整的测试体系（80%+ 覆盖率）

#### 不在第一阶段范围

-   ❌ 业务实体（Invoice、Task、Project、Candidate 等 213 个业务实体）
-   ❌ 业务插件（可后续作为可选插件实现）
-   ❌ 前端应用（只专注于服务端）

### 1.3 参考代码库

项目基于 `qauzy-backup` 目录下的 Gauzy 项目进行简化：

-   **业务模块**: 146 个业务模块
-   **实体数量**: 167 个实体（223 个文件，包括关系）
-   **功能特性**: 57 个功能特性
-   **插件数量**: 39 个插件
-   **包数量**: 20 个基础包

---

## 2. 技术架构

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                     OKSAI SAAS 平台                      │
├─────────────────────────────────────────────────────────────────┤
│                                                           │
│  ┌──────────────┐         ┌──────────────┐              │
│  │  客户端应用   │         │  管理后台    │              │
│  └──────┬───────┘         └──────┬───────┘              │
│         │                        │                        │
│         └────────────┬───────────┘                        │
│                      │                                    │
│  ┌───────────────────▼─────────────────────┐             │
│  │          API 网关层                   │             │
│  │  (NestJS + Express)                 │             │
│  └───────────────────┬─────────────────────┘             │
│                      │                                    │
│  ┌───────────────────▼─────────────────────┐             │
│  │         核心服务层                    │             │
│  │  ┌─────────┐  ┌─────────┐          │             │
│  │  │ Auth Svc│  │Tenant Svc│          │             │
│  │  └─────────┘  └─────────┘          │             │
│  │  ┌─────────┐  ┌─────────┐          │             │
│  │  │User Svc │  │Role Svc │          │             │
│  │  └─────────┘  └─────────┘          │             │
│  │  ┌─────────┐  ┌─────────┐          │             │
│  │  │Audit Svc│  │Plugin Svc│          │             │
│  │  └─────────┘  └─────────┘          │             │
│  └───────────────────┬─────────────────────┘             │
│                      │                                    │
│  ┌───────────────────▼─────────────────────┐             │
│  │         数据访问层 (DAL)                │             │
│  │        (MikroORM + PostgreSQL)       │             │
│  └──────────────────────────────────────────┘             │
│                                                           │
│  ┌─────────────────────────────────────────┐              │
│  │         插件系统                     │              │
│  │  ┌──────────────┐  ┌──────────┐  │              │
│  │  │ 系统插件     │  │业务插件  │  │              │
│  │  │ (Protected) │  │(Optional)│  │              │
│  │  └──────────────┘  └──────────┘  │              │
│  └─────────────────────────────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 分层架构

#### 表现层 (Presentation Layer)

-   **控制器 (Controllers)**: 处理 HTTP 请求
-   **DTO (Data Transfer Objects)**: 请求/响应数据验证
-   **守卫 (Guards)**: 认证和授权
-   **拦截器 (Interceptors)**: 日志、错误处理、响应转换

#### 业务逻辑层 (Business Logic Layer)

-   **服务 (Services)**: 核心业务逻辑
-   **插件管理器 (Plugin Manager)**: 插件注册、加载、卸载
-   **策略 (Strategies)**: 第三方认证策略

#### 数据访问层 (Data Access Layer)

-   **实体 (Entities)**: 数据库模型
-   **仓储 (Repositories)**: 数据访问抽象
-   **MikroORM 核心**: ORM 框架

#### 基础设施层 (Infrastructure Layer)

-   **配置管理**: 环境变量、配置加载
-   **日志系统**: 结构化日志
-   **错误追踪**: Sentry 集成（可选插件）
-   **缓存**: Redis（可选，未来扩展）

### 2.3 包依赖关系

```
@oksai/core
    ├── @oksai/config
    └── @oksai/database

@oksai/auth
    ├── @oksai/core
    └── @oksai/plugin

@oksai/tenant
    ├── @oksai/core
    └── @oksai/plugin

@oksai/user
    ├── @oksai/core
    └── @oksai/plugin

@oksai/organization
    ├── @oksai/core
    └── @oksai/plugin

@oksai/role
    ├── @oksai/core
    └── @oksai/plugin

@oksai/audit
    ├── @oksai/core
    └── @oksai/plugin

@oksai/analytics
    ├── @oksai/core
    └── @oksai/plugin

@oksai/reporting
    ├── @oksai/core
    └── @oksai/plugin

@oksai/plugin
    └── @nestjs/common

@oksai/database
    └── @mikro-orm/core
```

---

## 3. 技术栈

### 3.1 核心技术

| 技术       | 版本     | 用途        |
| ---------- | -------- | ----------- |
| Node.js    | >=20.0.0 | 运行时环境  |
| TypeScript | ^5.9.0   | 开发语言    |
| NestJS     | ^11.1.12 | Web 框架    |
| Express    | ^5.2.1   | HTTP 服务器 |

### 3.2 数据库技术

| 技术          | 版本  | 用途               |
| ------------- | ----- | ------------------ |
| MikroORM      | ^6.x  | ORM 框架           |
| PostgreSQL    | >=15  | 主数据库（默认）   |
| MongoDB       | >=7.0 | 备选数据库（预留） |
| Better-SQLite | ^9.x  | 测试数据库         |

### 3.3 认证与授权

| 技术                    | 版本    | 用途            |
| ----------------------- | ------- | --------------- |
| Passport                | ^0.7.0  | 认证中间件      |
| passport-google-oauth20 | ^2.0.0  | Google OAuth    |
| passport-github2        | ^0.1.12 | GitHub OAuth    |
| passport-azure-ad       | ^5.0.0  | Microsoft OAuth |
| passport-auth0          | ^1.4.0  | Auth0 OAuth     |
| jsonwebtoken            | ^9.0.2  | JWT 令牌        |

### 3.4 测试技术

| 技术        | 版本     | 用途          |
| ----------- | -------- | ------------- |
| Jest        | ^29.7.0  | 测试框架      |
| Supertest   | ^6.3.3   | HTTP 测试     |
| @types/jest | ^29.5.14 | Jest 类型定义 |

### 3.5 开发工具

| 技术       | 版本    | 用途              |
| ---------- | ------- | ----------------- |
| pnpm       | >=9.0.0 | 包管理器          |
| ESLint     | ^9.x    | 代码检查          |
| Prettier   | ^3.x    | 代码格式化        |
| TypeScript | ^5.9.0  | 类型检查          |
| turbo      | ^2.x    | Monorepo 构建工具 |

### 3.6 已移除的技术

| 技术            | 移除原因              |
| --------------- | --------------------- |
| TypeORM         | 简化为只使用 MikroORM |
| @nestjs/typeorm | 配套 TypeORM 集成     |
| 多 ORM 抽象层   | 不需要支持多 ORM      |
| Facebook OAuth  | 不需要的第三方认证    |
| LinkedIn OAuth  | 不需要的第三方认证    |
| Twitter OAuth   | 不需要的第三方认证    |
| Keycloak OAuth  | 不需要的第三方认证    |
| Fiverr OAuth    | 不需要的第三方认证    |

---

## 4. 数据库设计

### 4.1 核心实体清单

#### 基础实体 (Base Entities)

| 实体名称                     | 用途                     | 继承关系         |
| ---------------------------- | ------------------------ | ---------------- |
| BaseEntity                   | 所有实体的基类           | 无               |
| TenantBaseEntity             | 需要租户隔离的实体基类   | BaseEntity       |
| TenantOrganizationBaseEntity | 需要租户和组织的实体基类 | TenantBaseEntity |

#### 系统实体 (System Entities)

| 实体名称            | 用途         | 所属插件     | 必需性 |
| ------------------- | ------------ | ------------ | ------ |
| Tenant              | 租户         | tenant       | 必需   |
| User                | 用户         | user         | 必需   |
| Role                | 角色         | role         | 必需   |
| Permission          | 权限         | role         | 必需   |
| Organization        | 组织         | organization | 必需   |
| Invite              | 用户邀请     | user         | 必需   |
| Feature             | 功能特性     | core         | 必需   |
| FeatureOrganization | 组织功能开关 | core         | 必需   |

#### 审计实体 (Audit Entities)

| 实体名称 | 用途     | 所属插件 | 必需性 |
| -------- | -------- | -------- | ------ |
| AuditLog | 审计日志 | audit    | 必需   |

#### 分析实体 (Analytics Entities)

| 实体名称        | 用途     | 所属插件  | 必需性 |
| --------------- | -------- | --------- | ------ |
| AnalyticsEvent  | 分析事件 | analytics | 必需   |
| AnalyticsMetric | 分析指标 | analytics | 必需   |
| AnalyticsReport | 分析报表 | analytics | 必需   |

#### 报表实体 (Reporting Entities)

| 实体名称       | 用途     | 所属插件  | 必需性 |
| -------------- | -------- | --------- | ------ |
| Report         | 报表     | reporting | 必需   |
| ReportTemplate | 报表模板 | reporting | 必需   |
| ReportSchedule | 报表计划 | reporting | 必需   |

### 4.2 实体详细设计

#### BaseEntity

**用途**: 所有实体的基类，提供通用字段

**字段**:

-   `id`: UUID (主键)
-   `isActive`: Boolean (是否激活)
-   `isArchived`: Boolean (是否归档)
-   `archivedAt`: Date (归档时间)
-   `createdAt`: Date (创建时间)
-   `updatedAt`: Date (更新时间)
-   `deletedAt`: Date (软删除时间)
-   `createdByUserId`: UUID (创建人 ID)
-   `updatedByUserId`: UUID (更新人 ID)
-   `deletedByUserId`: UUID (删除人 ID)

**索引**: id, isActive, isArchived

**软删除**: 使用 `mikro-orm-soft-delete`

#### TenantBaseEntity

**用途**: 需要租户隔离的实体基类

**字段**:

-   继承 BaseEntity 所有字段
-   `tenantId`: UUID (租户 ID，外键)
-   `tenant`: Tenant (租户对象，关系)

**索引**: tenantId

**数据隔离**: 租户级别隔离

#### Tenant

**用途**: 租户，多租户核心实体

**字段**:

-   `id`: UUID (主键)
-   `name`: String (租户名称，唯一)
-   `logo`: String (租户 Logo URL)
-   `standardWorkHoursPerDay`: Number (标准工作时长，默认 8)
-   `imageId`: UUID (图片 ID，外键)
-   `isActive`: Boolean (是否激活)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `image`: ManyToOne → ImageAsset (Logo)
-   `organizations`: OneToMany → Organization
-   `rolePermissions`: OneToMany → RolePermission
-   `featureOrganizations`: OneToMany → FeatureOrganization

**索引**: name (unique), isActive

#### User

**用途**: 用户，认证核心实体

**字段**:

-   `id`: UUID (主键)
-   `email`: String (邮箱，唯一，必填)
-   `password`: String (加密密码，可选)
-   `firstName`: String (名)
-   `lastName`: String (姓)
-   `imageUrl`: String (头像 URL)
-   `isActive`: Boolean (是否激活)
-   `verified`: Boolean (邮箱是否验证)
-   `roleId`: UUID (角色 ID，外键)
-   `tenantId`: UUID (租户 ID，外键)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `role`: ManyToOne → Role
-   `tenant`: ManyToOne → Tenant
-   `invites`: OneToMany → Invite
-   `organizations`: ManyToMany → Organization

**索引**: email (unique), isActive, tenantId

**密码加密**: bcrypt

#### Role

**用途**: 角色，权限管理核心实体

**字段**:

-   `id`: UUID (主键)
-   `name`: String (角色名称，唯一)
-   `description`: String (角色描述)
-   `isSystem`: Boolean (是否系统角色)
-   `tenantId`: UUID (租户 ID，可选)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `permissions`: ManyToMany → Permission
-   `users`: OneToMany → User

**索引**: name (unique), tenantId

#### Permission

**用途**: 权限，RBAC 核心实体

**字段**:

-   `id`: UUID (主键)
-   `name`: String (权限名称，唯一)
-   `description`: String (权限描述)
-   `group`: String (权限分组)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `roles`: ManyToMany → Role

**索引**: name (unique)

#### Organization

**用途**: 组织，多组织支持

**字段**:

-   `id`: UUID (主键)
-   `name`: String (组织名称)
-   `slug`: String (组织标识，唯一)
-   `imageUrl`: String (组织 Logo URL)
-   `currency`: String (默认货币)
-   `isActive`: Boolean (是否激活)
-   `tenantId`: UUID (租户 ID，外键)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `tenant`: ManyToOne → Tenant
-   `users`: ManyToMany → User
-   `invites`: ManyToMany → Invite

**索引**: name, slug (unique), tenantId, isActive

#### Invite

**用途**: 用户邀请

**字段**:

-   `id`: UUID (主键)
-   `email`: String (邀请邮箱)
-   `fullName`: String (邀请全名)
-   `token`: String (邀请令牌，唯一)
-   `status`: Enum (INVITED, ACCEPTED, REJECTED, EXPIRED)
-   `expireDate`: Date (过期时间)
-   `actionDate`: Date (操作时间)
-   `code`: String (验证码)
-   `roleId`: UUID (角色 ID，外键)
-   `userId`: UUID (用户 ID，外键)
-   `invitedByUserId`: UUID (邀请人 ID，外键)
-   `tenantId`: UUID (租户 ID，外键)
-   `organizationId`: UUID (组织 ID，外键)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `role`: ManyToOne → Role
-   `user`: ManyToOne → User
-   `invitedByUser`: ManyToOne → User
-   `tenant`: ManyToOne → Tenant
-   `organization`: ManyToOne → Organization
-   `projects`: ManyToMany → OrganizationProject
-   `teams`: ManyToMany → OrganizationTeam

**索引**: email, token (unique), status, tenantId

#### Feature

**用途**: 功能特性，功能开关

**字段**:

-   `id`: UUID (主键)
-   `name`: String (功能名称)
-   `code`: Enum (功能代码，唯一)
-   `description`: String (功能描述)
-   `isPaid`: Boolean (是否付费)
-   `status`: String (功能状态)
-   `image`: String (功能图标)
-   `link`: String (功能链接)
-   `icon`: String (图标名称)
-   `parentId`: UUID (父功能 ID，外键)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `parent`: ManyToOne → Feature
-   `children`: OneToMany → Feature
-   `featureOrganizations`: OneToMany → FeatureOrganization

**索引**: code (unique), parentId

**功能代码枚举**: 57 个功能特性（参考 qauzy-backup）

#### FeatureOrganization

**用途**: 组织功能开关

**字段**:

-   `id`: UUID (主键)
-   `featureId`: UUID (功能 ID，外键)
-   `organizationId`: UUID (组织 ID，外键)
-   `isEnabled`: Boolean (是否启用)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `feature`: ManyToOne → Feature
-   `organization`: ManyToOne → Organization

**索引**: featureId, organizationId, isEnabled

#### AuditLog

**用途**: 审计日志

**字段**:

-   `id`: UUID (主键)
-   `action`: String (操作类型，如 CREATE, UPDATE, DELETE)
-   `entity`: String (实体名称)
-   `entityId`: UUID (实体 ID)
-   `userId`: UUID (操作人 ID，外键)
-   `tenantId`: UUID (租户 ID，外键)
-   `organizationId`: UUID (组织 ID，外键)
-   `oldValue`: JSON (旧值)
-   `newValue`: JSON (新值)
-   `ipAddress`: String (IP 地址)
-   `userAgent`: String (用户代理)
-   `createdAt`, `updatedAt`

**关系**:

-   `user`: ManyToOne → User
-   `tenant`: ManyToOne → Tenant
-   `organization`: ManyToOne → Organization

**索引**: action, entity, entityId, userId, tenantId, createdAt

#### AnalyticsEvent

**用途**: 分析事件

**字段**:

-   `id`: UUID (主键)
-   `eventType`: String (事件类型)
-   `eventName`: String (事件名称)
-   `userId`: UUID (用户 ID，外键)
-   `tenantId`: UUID (租户 ID，外键)
-   `organizationId`: UUID (组织 ID，外键)
-   `properties`: JSON (事件属性)
-   `timestamp`: Date (事件时间)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `user`: ManyToOne → User
-   `tenant`: ManyToOne → Tenant
-   `organization`: ManyToOne → Organization

**索引**: eventType, eventName, userId, tenantId, timestamp

#### AnalyticsMetric

**用途**: 分析指标

**字段**:

-   `id`: UUID (主键)
-   `metricName`: String (指标名称)
-   `metricValue`: Number (指标值)
-   `metricType`: String (指标类型，如 COUNTER, GAUGE)
-   `userId`: UUID (用户 ID，外键)
-   `tenantId`: UUID (租户 ID，外键)
-   `organizationId`: UUID (组织 ID，外键)
-   `tags`: JSON (标签)
-   `timestamp`: Date (指标时间)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `user`: ManyToOne → User
-   `tenant`: ManyToOne → Tenant
-   `organization`: ManyToOne → Organization

**索引**: metricName, userId, tenantId, timestamp

#### Report

**用途**: 报表

**字段**:

-   `id`: UUID (主键)
-   `name`: String (报表名称)
-   `description`: String (报表描述)
-   `reportType`: Enum (报表类型，如 TABLE, CHART)
-   `templateId`: UUID (模板 ID，外键)
-   `userId`: UUID (创建人 ID，外键)
-   `tenantId`: UUID (租户 ID，外键)
-   `organizationId`: UUID (组织 ID，外键)
-   `isActive`: Boolean (是否激活)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `template`: ManyToOne → ReportTemplate
-   `user`: ManyToOne → User
-   `tenant`: ManyToOne → Tenant
-   `organization`: ManyToOne → Organization
-   `schedules`: OneToMany → ReportSchedule

**索引**: name, reportType, tenantId, organizationId

#### ReportTemplate

**用途**: 报表模板

**字段**:

-   `id`: UUID (主键)
-   `name`: String (模板名称)
-   `description`: String (模板描述)
-   `config`: JSON (模板配置)
-   `isSystem`: Boolean (是否系统模板)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `reports`: OneToMany → Report

**索引**: name, isSystem

#### ReportSchedule

**用途**: 报表计划

**字段**:

-   `id`: UUID (主键)
-   `reportId`: UUID (报表 ID，外键)
-   `scheduleType`: Enum (计划类型，如 DAILY, WEEKLY, MONTHLY)
-   `scheduleConfig`: JSON (计划配置)
-   `lastRunAt`: Date (上次运行时间)
-   `nextRunAt`: Date (下次运行时间)
-   `isActive`: Boolean (是否激活)
-   `createdAt`, `updatedAt`, `deletedAt`

**关系**:

-   `report`: ManyToOne → Report

**索引**: reportId, scheduleType, nextRunAt, isActive

### 4.3 数据库配置

#### PostgreSQL 配置 (默认)

```typescript
{
  type: 'postgresql',
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '5432'),
  user: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASSWORD || 'postgres',
  dbName: process.env.DB_NAME || 'oksai',
  entities: ['dist/**/*.entity.js'],
  migrations: {
    path: './migrations',
    pathTs: './migrations'
  }
}
```

#### MongoDB 配置 (预留)

```typescript
{
  type: 'mongo',
  clientUrl: process.env.MONGO_URI,
  dbName: process.env.MONGO_DB_NAME || 'oksai',
  entities: ['dist/**/*.entity.js']
}
```

#### Better-SQLite 配置 (测试)

```typescript
{
  type: 'sqlite',
  dbName: ':memory:',
  entities: ['dist/**/*.entity.js']
}
```

### 4.4 数据迁移策略

-   使用 MikroORM 迁移系统
-   迁移文件存储在 `migrations/` 目录
-   支持向上和向下迁移
-   自动检测数据库版本并执行必要的迁移

---

## 5. 插件系统架构

### 5.1 插件分类

#### 系统插件 (System Plugins)

**特点**:

-   类型: `PluginType.SYSTEM`
-   优先级: `PluginPriority.P0`
-   保护: `isProtected: true`
-   可禁用: 否
-   可卸载: 否

**列表**:

1. **@oksai/auth** - 认证系统
2. **@oksai/tenant** - 租户管理
3. **@oksai/user** - 用户管理
4. **@oksai/organization** - 组织管理
5. **@oksai/role** - 角色权限管理
6. **@oksai/audit** - 审计日志
7. **@oksai/analytics** - 数据分析
8. **@oksai/reporting** - 报表系统

#### 业务插件 (Business Plugins)

**特点**:

-   类型: `PluginType.BUSINESS`
-   优先级: `PluginPriority.P1-P3`
-   保护: `isProtected: false`
-   可禁用: 是
-   可卸载: 是

**示例** (未来可选实现):

-   财务管理插件
-   任务管理插件
-   项目管理插件
-   招聘管理插件
-   客户关系管理插件
-   时间追踪插件
-   邮件营销插件
-   等等...

### 5.2 插件接口

#### IPlugin 接口

```typescript
export interface IPlugin {
	// 基本信息
	name: string;
	displayName: string;
	version: string;
	description: string;

	// 分类信息
	type: PluginType;
	priority: PluginPriority;
	category: string;

	// 作者信息
	author: {
		name: string;
		email?: string;
		url?: string;
	};

	// 控制信息
	isProtected: boolean; // 是否受保护（系统插件为 true）
	isConfigurable: boolean; // 是否可配置

	// 功能定义
	permissions: string[]; // 权限要求
	api: Array<{
		path: string;
		method: string;
		description: string;
	}>;
	features?: string[]; // 提供的功能特性
	dependencies?: string[]; // 依赖的其他插件

	// 生命周期钩子
	onPluginBootstrap?(): void | Promise<void>;
	onPluginDestroy?(): void | Promise<void>;
}
```

#### 插件生命周期

```
插件加载流程:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  注册插件   │ -> │  检查依赖  │ -> │  加载模块   │ -> │  执行启动钩子│
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘

插件卸载流程:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  执行销毁钩子│ -> │  卸载模块   │ -> │  从注册表移除│
└─────────────┘    └─────────────┘    └─────────────┘
```

### 5.3 插件注册服务

#### PluginRegistryService

**核心方法**:

-   `registerPlugin(plugin: IPlugin): void` - 注册插件
-   `getPlugins(type?: PluginType): IPlugin[]` - 获取插件
-   `getSystemPlugins(): IPlugin[]` - 获取系统插件
-   `getBusinessPlugins(): IPlugin[]` - 获取业务插件
-   `getPlugin(name: string): IPlugin | undefined` - 获取单个插件
-   `enablePlugin(name: string): Promise<void>` - 启用插件
-   `disablePlugin(name: string): Promise<void>` - 禁用插件
-   `isPluginEnabled(name: string): boolean` - 检查插件状态
-   `isPluginProtected(name: string): boolean` - 检查是否受保护
-   `checkDependencies(plugin: IPlugin): { valid: boolean; missing: string[] }` - 检查依赖
-   `getPluginDependencies(pluginName: string): string[]` - 获取插件依赖
-   `getPluginFeatures(pluginName: string): string[]` - 获取插件功能
-   `getPluginsByFeature(featureCode: string): IPlugin[]` - 按功能查找插件

### 5.4 插件加载服务

#### PluginLoaderService

**核心方法**:

-   `loadPlugins(): Promise<void>` - 加载所有插件
-   `loadPlugin(name: string): Promise<void>` - 加载单个插件
-   `unloadPlugin(name: string): Promise<void>` - 卸载插件
-   `reloadPlugin(name: string): Promise<void>` - 重载插件
-   `getPluginStatus(name: string): PluginStatus` - 获取插件状态
-   `getAllPluginStatus(): Map<string, PluginStatus>` - 获取所有插件状态

#### PluginStatus 枚举

```typescript
enum PluginStatus {
	LOADED = 'loaded',
	UNLOADED = 'unloaded',
	LOADING = 'loading',
	ERROR = 'error'
}
```

### 5.5 插件 API 端点

| 端点                         | 方法 | 描述             |
| ---------------------------- | ---- | ---------------- |
| `/api/plugins`               | GET  | 获取所有插件     |
| `/api/plugins?type=system`   | GET  | 获取系统插件     |
| `/api/plugins?type=business` | GET  | 获取业务插件     |
| `/api/plugins/:name`         | GET  | 获取单个插件详情 |
| `/api/plugins/:name/enable`  | POST | 启用插件         |
| `/api/plugins/:name/disable` | POST | 禁用插件         |
| `/api/plugins/:name/reload`  | POST | 重载插件         |
| `/api/plugins/:name/status`  | GET  | 获取插件状态     |
| `/api/plugins/status`        | GET  | 获取所有插件状态 |

**权限控制**:

-   插件控制端点需要管理员权限
-   系统插件不能被禁用或卸载

### 5.6 插件热拔插机制

#### 热拔插流程

1. **加载插件**:

    - 检查依赖关系
    - 加载插件模块
    - 注册插件路由和中间件
    - 执行 `onPluginBootstrap` 钩子
    - 标记插件为 `LOADED` 状态

2. **卸载插件**:

    - 检查是否有其他插件依赖
    - 执行 `onPluginDestroy` 钩子
    - 移除插件路由和中间件
    - 清理插件资源
    - 标记插件为 `UNLOADED` 状态

3. **重载插件**:
    - 执行卸载流程
    - 执行加载流程

#### 依赖管理

-   在加载插件前检查所有依赖
-   如果依赖不满足，插件无法加载
-   禁用插件时，检查是否影响其他插件

#### 冲突检测

-   检查插件是否提供相同的功能特性
-   检查插件是否使用相同的 API 端点
-   如果检测到冲突，记录警告

---

## 6. 认证系统

### 6.1 认证流程

#### JWT 认证流程

```
用户登录
    │
    ├── 验证邮箱和密码
    │
    ├── 生成 JWT Access Token (7天有效期)
    │
    ├── 生成 JWT Refresh Token (30天有效期)
    │
    └── 返回用户信息和令牌
         │
         ├── Access Token 用于 API 访问
         │
         ├── Refresh Token 用于刷新 Access Token
         │
         └── 用户信息用于前端展示
```

#### 第三方认证流程

```
第三方登录 (以 Google 为例)
    │
    ├── 重定向到 Google OAuth
    │
    ├── 用户授权后回调
    │
    ├── 使用授权码获取访问令牌
    │
    ├── 使用访问令牌获取用户信息
    │
    ├── 检查用户是否存在
    │   ├── 存在: 生成 JWT 令牌
    │   └── 不存在: 创建新用户，然后生成 JWT 令牌
    │
    └── 返回用户信息和 JWT 令牌
```

### 6.2 支持的认证提供商

| 提供商         | 状态      | 用途                    |
| -------------- | --------- | ----------------------- |
| **Google**     | ✅ 已实现 | Google OAuth 2.0 认证   |
| **Microsoft**  | ⚠️ 待添加 | Microsoft Azure AD 认证 |
| **GitHub**     | ✅ 已实现 | GitHub OAuth 2.0 认证   |
| **Auth0**      | ✅ 已实现 | Auth0 认证              |
| Email/Password | ✅ 已实现 | 传统邮箱密码认证        |

### 6.3 令牌管理

#### Access Token

-   **有效期**: 7 天
-   **用途**: API 访问
-   **格式**: JWT
-   **存储**: 客户端内存或 SessionStorage
-   **刷新**: 使用 Refresh Token

#### Refresh Token

-   **有效期**: 30 天
-   **用途**: 刷新 Access Token
-   **格式**: JWT
-   **存储**: 客户端持久化存储
-   **刷新**: `/api/auth/refresh` 端点

#### 令牌刷新机制

```
Access Token 过期
    │
    ├── 客户端检测到 401 Unauthorized
    │
    ├── 使用 Refresh Token 调用刷新端点
    │
    ├── 验证 Refresh Token
    │
    ├── 生成新的 Access Token
    │
    ├── 可选: 生成新的 Refresh Token
    │
    └── 返回新令牌
```

### 6.4 认证中间件

#### JwtAuthGuard

-   **用途**: 保护需要认证的路由
-   **实现**: 从请求头提取 JWT 令牌
-   **验证**: 验证令牌有效性
-   **装饰器**: `@UseGuards(JwtAuthGuard)`

#### RolesGuard

-   **用途**: 检查用户角色
-   **装饰器**: `@Roles('ADMIN', 'USER')`
-   **实现**: 验证用户角色是否匹配

#### PermissionsGuard

-   **用途**: 检查用户权限
-   **装饰器**: `@Permissions('users:read', 'users:write')`
-   **实现**: 验证用户是否拥有所需权限

### 6.5 认证配置

#### 环境变量

```env
# JWT 配置
JWT_SECRET=your-secret-key
JWT_EXPIRY=7d
JWT_REFRESH_SECRET=your-refresh-secret-key
JWT_REFRESH_EXPIRY=30d

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_CALLBACK_URL=http://localhost:3000/api/auth/google/callback

# Microsoft OAuth
MICROSOFT_CLIENT_ID=your-microsoft-client-id
MICROSOFT_CLIENT_SECRET=your-microsoft-client-secret
MICROSOFT_CALLBACK_URL=http://localhost:3000/api/auth/microsoft/callback

# GitHub OAuth
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret
GITHUB_CALLBACK_URL=http://localhost:3000/api/auth/github/callback

# Auth0
AUTH0_CLIENT_ID=your-auth0-client-id
AUTH0_CLIENT_SECRET=your-auth0-client-secret
AUTH0_CALLBACK_URL=http://localhost:3000/api/auth/auth0/callback
AUTH0_DOMAIN=your-domain.auth0.com
```

---

## 7. 多租户架构

### 7.1 租户隔离策略

#### 数据库级别隔离

-   **方案**: 行级隔离（Row-Level Security）
-   **实现**: 所有业务实体继承 `TenantBaseEntity`
-   **查询**: 自动添加 `tenantId` 过滤条件
-   **保证**: 租户 A 无法访问租户 B 的数据

#### 租户上下文

```typescript
@Interceptor()
export class TenantInterceptor {
	intercept(context: ExecutionContext): Observable<any> {
		const request = context.switchToHttp().getRequest();
		const tenantId = request.headers['x-tenant-id'];

		// 设置租户上下文
		TenantContext.setTenantId(tenantId);

		return next.handle();
	}
}
```

### 7.2 租户识别

#### 识别方式

1. **子域名** (Subdomain): `tenant1.oksai.io`
2. **路径前缀** (Path Prefix): `/api/tenant1/...`
3. **请求头** (Header): `X-Tenant-Id: tenant-id`

**推荐**: 使用请求头方式，最灵活

### 7.3 租户数据模型

```
租户 (Tenant)
    │
    ├── 组织 (Organization)
    │   ├── 用户 (User)
    │   ├── 角色 (Role)
    │   └── 权限 (Permission)
    │
    ├── 功能开关 (FeatureOrganization)
    │
    └── 审计日志 (AuditLog)
```

### 7.4 跨租户控制

-   **系统管理员**: 可以访问所有租户数据
-   **租户管理员**: 只能访问自己租户的数据
-   **租户用户**: 只能访问自己租户的数据，受角色权限限制

---

## 8. API 设计

### 8.1 RESTful API 设计原则

-   使用标准 HTTP 方法：GET, POST, PUT, PATCH, DELETE
-   使用标准 HTTP 状态码
-   使用 JSON 格式
-   版本化：`/api/v1/...`

### 8.2 API 路径结构

```
/api/v1
    ├── /auth               # 认证相关
    │   ├── /login
    │   ├── /register
    │   ├── /logout
    │   ├── /refresh
    │   ├── /google/callback
    │   ├── /microsoft/callback
    │   ├── /github/callback
    │   └── /auth0/callback
    │
    ├── /tenant             # 租户管理
    │   ├── /
    │   ├── /:id
    │   └── /slug/:slug
    │
    ├── /users              # 用户管理
    │   ├── /
    │   ├── /:id
    │   ├── /me
    │   └── /invite
    │
    ├── /organizations      # 组织管理
    │   ├── /
    │   └── /:id
    │
    ├── /roles             # 角色管理
    │   ├── /
    │   └── /:id
    │
    ├── /permissions        # 权限管理
    │   └── /
    │
    ├── /audit             # 审计日志
    │   ├── /
    │   └── /:id
    │
    ├── /analytics         # 数据分析
    │   ├── /events
    │   ├── /metrics
    │   └── /reports
    │
    ├── /reporting         # 报表系统
    │   ├── /
    │   ├── /templates
    │   └── /schedules
    │
    └── /plugins           # 插件管理
        ├── /
        ├── /:name
        ├── /:name/enable
        ├── /:name/disable
        └── /:name/reload
```

### 8.3 API 响应格式

#### 成功响应

```json
{
	"success": true,
	"data": {
		// 响应数据
	},
	"message": "操作成功"
}
```

#### 错误响应

```json
{
	"success": false,
	"error": {
		"code": "ERROR_CODE",
		"message": "错误描述",
		"details": {}
	}
}
```

#### 分页响应

```json
{
	"success": true,
	"data": {
		"items": [],
		"total": 100,
		"page": 1,
		"limit": 10,
		"pages": 10
	}
}
```

### 8.4 API 文档

-   **工具**: Swagger/OpenAPI
-   **访问路径**: `http://localhost:3000/api/docs`
-   **自动生成**: 从控制器和装饰器生成
-   **包含**: 端点、参数、响应、示例

---

## 9. 安全性

### 9.1 认证安全

-   **密码加密**: bcrypt (cost: 10)
-   **JWT 密钥**: 环境变量，长度 >= 32
-   **令牌有效期**: Access Token 7 天，Refresh Token 30 天
-   **HTTPS**: 生产环境强制使用 HTTPS

### 9.2 授权安全

-   **RBAC**: 基于角色的访问控制
-   **权限检查**: 每个端点验证权限
-   **租户隔离**: 自动过滤租户数据

### 9.3 数据安全

-   **输入验证**: class-validator
-   **SQL 注入防护**: ORM 参数化查询
-   **XSS 防护**: 转义用户输入
-   **CSRF 防护**: CSRF Token
-   **敏感数据**: 不记录密码、令牌等

### 9.4 API 安全

-   **速率限制**: 100 请求/分钟
-   **IP 白名单**: 可选，限制访问来源
-   **请求日志**: 记录所有 API 请求
-   **错误追踪**: Sentry 集成（可选）

### 9.5 环境变量安全

-   **不提交**: `.env` 文件不提交到 Git
-   **模板**: `.env.example` 提供模板
-   **密钥管理**: 建议使用密钥管理服务

---

## 10. 性能优化

### 10.1 数据库优化

-   **索引**: 为常用查询字段添加索引
-   **查询优化**: 使用 MikroORM 查询构建器
-   **连接池**: 配置数据库连接池
-   **缓存**: Redis 缓存热点数据（预留）

### 10.2 API 优化

-   **响应压缩**: Gzip 压缩
-   **静态文件缓存**: 缓存静态资源
-   **分页**: 所有列表端点支持分页
-   **字段选择**: 允许客户端选择返回字段

### 10.3 日志优化

-   **结构化日志**: 使用 Winston 或 Pino
-   **日志级别**: 开发环境 DEBUG，生产环境 INFO
-   **异步日志**: 不阻塞请求处理

### 10.4 监控与追踪

-   **性能监控**: 监控 API 响应时间
-   **错误追踪**: Sentry 集成（可选插件）
-   **请求追踪**: 分布式追踪（预留）

---

## 附录

### A. 术语表

| 术语  | 定义                                                |
| ----- | --------------------------------------------------- |
| SAAS  | Software as a Service，软件即服务                   |
| ORM   | Object-Relational Mapping，对象关系映射             |
| JWT   | JSON Web Token，JSON Web 令牌                       |
| RBAC  | Role-Based Access Control，基于角色的访问控制       |
| P0-P3 | 优先级级别，P0 最高，P3 最低                        |
| DTO   | Data Transfer Object，数据传输对象                  |
| API   | Application Programming Interface，应用程序编程接口 |

### B. 参考文档

-   AGENTS.md - 代理指南
-   CODING_STANDARDS.md - 代码规范
-   ARCHITECTURE.md - 架构文档
-   DATABASE_SCHEMA.md - 数据库架构
-   PLUGIN_DEVELOPMENT.md - 插件开发指南

### C. 变更历史

| 版本  | 日期       | 变更内容 |
| ----- | ---------- | -------- |
| 1.0.0 | 2026-02-07 | 初始版本 |

---

**文档结束**
