# OKSAI SAAS 服务端框架 - 工作计划文档

**版本**: 1.1.0
**创建日期**: 2026-02-07
**文档类型**: 工作计划
**状态**: 进行中（67% 完成）
**预估总工时**: 27-36 小时

---

## 文档概述

本文档详细描述 OKSAI SAAS 服务端框架第一阶段的工作计划，包括任务分解、时间估算、依赖关系、验收标准等。

---

## 目录

1. [项目目标](#1-项目目标)
2. [工作范围](#2-工作范围)
3. [任务分解](#3-任务分解)
4. [实施顺序](#4-实施顺序)
5. [依赖关系](#5-依赖关系)
6. [验收标准](#6-验收标准)
7. [风险与缓解](#7-风险与缓解)
8. [里程碑](#8-里程碑)

---

## 1. 项目目标

### 1.1 主要目标

构建一个轻量、可扩展的多租户 SAAS 服务端框架，满足以下核心需求：

1. **插件化架构**: 实现系统插件和业务插件的分类管理，支持热拔插
2. **简化的 ORM**: 只使用 MikroORM，移除 TypeORM 和多 ORM 抽象层
3. **核心实体简化**: 从 167 个实体简化到约 15 个核心实体
4. **第三方认证**: 添加 Microsoft 认证，确保 Google、GitHub、Auth0 正常工作
5. **高可测试性**: 建立完整的单元测试、集成测试、E2E 测试体系

### 1.2 成功标准

-   ✅ 所有代码符合 AGENTS.md 规范
-   ✅ 核心业务逻辑测试覆盖率达到 80%+
-   ✅ 所有公共 API 都有测试用例
-   ✅ 构建和类型检查通过
-   ✅ 应用可以成功启动和运行
-   ✅ 所有第三方认证正常工作
-   ✅ 插件系统支持热拔插

---

## 2. 工作范围

### 2.1 包含的工作

#### 第一阶段核心任务

1. **添加 Microsoft 认证**

    - 从 qauzy-backup 复制 Microsoft 认证代码
    - 更新 SocialAuthService
    - 配置环境变量

2. **简化 ORM 层**

    - 移除 MultiORM 装饰器
    - 替换为纯 MikroORM 装饰器
    - 移除 TypeORM 相关依赖

3. **简化数据库模型**

    - 保留约 15 个核心实体
    - 移除约 152 个业务实体
    - 配置多数据库支持

4. **完善插件系统**

    - 实现插件分类（系统 vs 业务）
    - 实现插件注册和加载服务
    - 实现插件热拔插机制
    - 实现 8 个系统插件

5. **测试策略实施**

    - 单元测试（核心业务逻辑）
    - 集成测试（关键流程）
    - E2E 测试（完整工作流）
    - 测试覆盖率达到 80%+

6. **配置与构建优化**

    - 完善 MikroORM 配置
    - 配置环境变量
    - 修复类型错误
    - 确保构建成功

7. **文档完善**
    - 插件开发文档
    - API 文档（Swagger）
    - 部署文档

### 2.2 不包含的工作

以下工作不在第一阶段范围内，建议在后续阶段实施：

-   ❌ 业务插件的开发（财务、任务、项目等）
-   ❌ 前端应用开发
-   ❌ 高级功能（如实时通知、WebSocket）
-   ❌ 性能优化（如 Redis 缓存）
-   ❌ 高级监控（如 Prometheus、Grafana）
-   ❌ CI/CD 管道配置

---

## 3. 任务分解

### 任务 1: 添加 Microsoft 认证

**预估工时**: 2-3 小时
**优先级**: P1
**状态**: ✅ 已完成

#### 子任务

| 子任务                      | 工时 | 描述                                 |
| --------------------------- | ---- | ------------------------------------ |
| 1.1 复制 Microsoft 认证代码 | 0.5h | 从 qauzy-backup 复制 microsoft/ 目录 |
| 1.2 更新 SocialAuthService  | 0.5h | 注册 Microsoft 策略和配置            |
| 1.3 更新 AuthModule         | 0.5h | 导入 Microsoft 相关模块              |
| 1.4 配置环境变量            | 0.5h | 添加 .env.example 模板               |
| 1.5 编写单元测试            | 1.0h | 为 Microsoft 认证编写测试            |

#### 详细步骤

**步骤 1.1**: 复制 Microsoft 认证代码

```bash
# 创建目录
mkdir -p libs/auth/src/lib/microsoft

# 复制文件
cp qauzy-backup/packages/auth/src/lib/microsoft/microsoft.strategy.ts \
   libs/auth/src/lib/microsoft/microsoft.strategy.ts

cp qauzy-backup/packages/auth/src/lib/microsoft/microsoft.controller.ts \
   libs/auth/src/lib/microsoft/microsoft.controller.ts

cp qauzy-backup/packages/auth/src/lib/microsoft/microsoft-auth-guard.ts \
   libs/auth/src/lib/microsoft/microsoft-auth-guard.ts
```

**步骤 1.2**: 更新 `libs/auth/src/lib/social-auth.service.ts`

```typescript
// 注册 Microsoft OAuth
getMicrosoftProfile(accessToken: string) {
  // 实现 Microsoft 用户信息获取
}
```

**步骤 1.3**: 更新 `libs/auth/src/lib/auth.module.ts`

```typescript
import { MicrosoftAuthModule } from './microsoft';
```

**步骤 1.4**: 更新环境变量

```env
# 添加到 .env.example
MICROSOFT_CLIENT_ID=
MICROSOFT_CLIENT_SECRET=
MICROSOFT_CALLBACK_URL=
```

**步骤 1.5**: 编写测试

```typescript
// libs/auth/src/lib/microsoft/microsoft.strategy.spec.ts
describe('MicrosoftStrategy', () => {
	it('should authenticate with Microsoft', async () => {
		// 测试逻辑
	});
});
```

#### 验收标准

-   ✅ Microsoft 认证策略正常工作
-   ✅ 用户可以通过 Microsoft 登录
-   ✅ 类型检查通过
-   ✅ 构建成功
-   ✅ 代码符合 AGENTS.md 规范
-   ✅ 包含完整的 TSDoc 注释

---

### 任务 2: 简化 ORM 层

**预估工时**: 4-5 小时
**优先级**: P0 (最高)
**状态**: ✅ 已完成

#### 子任务

| 子任务                | 工时 | 描述                               |
| --------------------- | ---- | ---------------------------------- |
| 2.1 创建迁移脚本      | 1.0h | 创建脚本自动替换装饰器             |
| 2.2 替换基础实体      | 1.0h | 更新 BaseEntity 等                 |
| 2.3 替换业务实体      | 1.5h | 更新 User、Tenant、Organization 等 |
| 2.4 移除 TypeORM 依赖 | 0.5h | 清理 package.json                  |
| 2.5 运行类型检查      | 0.5h | 修复类型错误                       |

#### 详细步骤

**步骤 2.1**: 创建迁移脚本

```typescript
// tools/migrate-orm.ts
const replacements = [
	{ from: '@MultiORMColumn()', to: '@Property()' },
	{ from: '@MultiORMManyToOne()', to: '@ManyToOne()' },
	{ from: '@MultiORMOneToMany()', to: '@OneToMany()' },
	{ from: '@MultiORMManyToMany()', to: '@ManyToMany()' },
	{ from: '@MultiORMEntity()', to: '@Entity()' }
];

// 执行替换
```

**步骤 2.2**: 更新 `libs/core/src/lib/entities/base.entity.ts`

```typescript
// 移除
import { PrimaryGeneratedColumn, CreateDateColumn, UpdateDateColumn, DeleteDateColumn } from 'typeorm';

// 保留
import { PrimaryKey, Property } from '@mikro-orm/core';

// 替换装饰器
@PrimaryKey({ type: 'uuid', defaultRaw: 'gen_random_uuid()' })
id?: ID;

@Property({
  onCreate: () => AccessTimestamps.getCurrentDate(),
  onUpdate: () => AccessTimestamps.getCurrentDate()
})
createdAt?: Date;
```

**步骤 2.3**: 批量更新实体文件

```bash
# 使用迁移脚本
pnpm ts-node tools/migrate-orm.ts
```

**步骤 2.4**: 移除 TypeORM 依赖

```bash
# 从所有 package.json 移除
"@nestjs/typeorm"
"typeorm"
```

**步骤 2.5**: 运行类型检查

```bash
pnpm run typecheck
# 修复错误直到通过
```

#### 验收标准

-   ✅ 所有 MultiORM 装饰器已替换
-   ✅ TypeORM 依赖已移除
-   ✅ 类型检查通过
-   ✅ 构建成功
-   ✅ 代码符合 AGENTS.md 规范

---

### 任务 3: 简化数据库模型

**预估工时**: 3-4 小时
**优先级**: P0
**状态**: ✅ 已完成

#### 子任务

| 子任务                     | 工时 | 描述                         |
| -------------------------- | ---- | ---------------------------- |
| 3.1 确定核心实体清单       | 0.5h | 列出需要保留的实体           |
| 3.2 从 backup 复制核心实体 | 1.0h | 复制并简化 15 个核心实体     |
| 3.3 更新实体继承关系       | 1.0h | 确保继承 TenantBaseEntity 等 |
| 3.4 配置 MikroORM          | 0.5h | 更新数据库配置文件           |
| 3.5 编写实体测试           | 1.0h | 为核心实体编写测试           |

#### 核心实体清单

**保留的核心实体** (约 15 个):

1. BaseEntity (基础实体)
2. TenantBaseEntity (租户基类)
3. TenantOrganizationBaseEntity (组织基类)
4. Tenant (租户)
5. User (用户)
6. Role (角色)
7. Permission (权限)
8. Organization (组织)
9. Invite (邀请)
10. Feature (功能特性)
11. FeatureOrganization (组织功能)
12. AuditLog (审计日志)
13. AnalyticsEvent (分析事件)
14. AnalyticsMetric (分析指标)
15. Report (报表)
16. ReportTemplate (报表模板)
17. ReportSchedule (报表计划)

**移除的业务实体** (约 152 个):

-   所有财务相关 (Invoice, Expense, Payment...)
-   所有员工相关 (Employee, EmployeeLevel...)
-   所有任务相关 (Task, Project, Team...)
-   所有招聘相关 (Candidate, Interview...)
-   所有目标相关 (Goal, KeyResult, KPI...)
-   等等...

#### 详细步骤

**步骤 3.1**: 创建实体清单文档

```typescript
// docs/spec-plan/核心实体清单.md
const CORE_ENTITIES = [
	'BaseEntity',
	'TenantBaseEntity'
	// ...
];
```

**步骤 3.2**: 从 backup 复制实体

```bash
# 示例：复制 Tenant 实体
cp qauzy-backup/packages/core/src/lib/tenant/tenant.entity.ts \
   libs/tenant/src/lib/entities/tenant.entity.ts

# 简化：移除 MultiORM 装饰器
# 使用任务 2 的结果
```

**步骤 3.3**: 更新实体继承

```typescript
// 确保所有业务实体继承正确的基类
@Entity({ tableName: 'user' })
export class User extends TenantBaseEntity implements IUser {
	// 字段定义
}
```

**步骤 3.4**: 更新 MikroORM 配置

```typescript
// apps/base-api/src/config/mikro-orm.config.ts
export default MikroOrmModule.forRoot({
	entities: [
		// 自动发现核心实体
		'./libs/*/src/lib/entities/*.entity.ts'
	],
	type: 'postgresql'
	// ... 其他配置
});
```

**步骤 3.5**: 编写实体测试

```typescript
// libs/tenant/src/lib/entities/tenant.entity.spec.ts
describe('Tenant', () => {
	it('should create a new tenant', async () => {
		// 测试逻辑
	});
});
```

#### 验收标准

-   ✅ 保留约 15 个核心实体
-   ✅ 移除约 152 个业务实体
-   ✅ 所有实体继承正确的基类
-   ✅ MikroORM 配置正确
-   ✅ 实体测试通过
-   ✅ 代码符合 AGENTS.md 规范

---

### 任务 4: 完善插件系统

**预估工时**: 6-8 小时
**优先级**: P0
**状态**: ✅ 已完成

#### 子任务

| 子任务               | 工时 | 描述                       |
| -------------------- | ---- | -------------------------- |
| 4.1 定义插件分类枚举 | 0.5h | PluginType, PluginPriority |
| 4.2 完善插件接口     | 1.0h | IPlugin 接口定义           |
| 4.3 实现插件注册服务 | 1.5h | PluginRegistryService      |
| 4.4 实现插件加载服务 | 1.5h | PluginLoaderService        |
| 4.5 实现插件控制器   | 1.0h | PluginController           |
| 4.6 更新现有插件定义 | 1.0h | 更新 8 个系统插件          |
| 4.7 编写插件系统测试 | 1.5h | 单元测试和集成测试         |

#### 详细步骤

**步骤 4.1**: 定义枚举

```typescript
// libs/plugin/src/enums/plugin-type.enum.ts
export enum PluginType {
	SYSTEM = 'system',
	BUSINESS = 'business'
}

// libs/plugin/src/enums/plugin-priority.enum.ts
export enum PluginPriority {
	P0 = 'p0',
	P1 = 'p1',
	P2 = 'p2',
	P3 = 'p3'
}
```

**步骤 4.2**: 完善接口

```typescript
// libs/plugin/src/interfaces/plugin.interface.ts
export interface IPlugin {
	// 基本信息
	name: string;
	displayName: string;
	version: string;
	description: string;

	// 分类信息
	type: PluginType;
	priority: PluginPriority;
	category: string;

	// 控制信息
	isProtected: boolean;
	isConfigurable: boolean;

	// 功能定义
	permissions: string[];
	api: Array<{ path: string; method: string; description: string }>;
	features?: string[];
	dependencies?: string[];

	// 生命周期
	onPluginBootstrap?(): void | Promise<void>;
	onPluginDestroy?(): void | Promise<void>;
}
```

**步骤 4.3**: 实现插件注册服务

```typescript
// libs/plugin/src/services/plugin-registry.service.ts
@Injectable()
export class PluginRegistryService {
	private plugins = new Map<string, IPlugin>();

	registerPlugin(plugin: IPlugin): void {
		this.plugins.set(plugin.name, plugin);
	}

	getPlugins(type?: PluginType): IPlugin[] {
		// 实现逻辑
	}

	enablePlugin(name: string): Promise<void> {
		// 实现逻辑
	}

	// ... 其他方法
}
```

**步骤 4.4**: 实现插件加载服务

```typescript
// libs/plugin/src/services/plugin-loader.service.ts
@Injectable()
export class PluginLoaderService {
	async loadPlugins(): Promise<void> {
		// 实现逻辑
	}

	async unloadPlugin(name: string): Promise<void> {
		// 实现逻辑
	}

	// ... 其他方法
}
```

**步骤 4.5**: 实现插件控制器

```typescript
// libs/plugin/src/lib/plugin.controller.ts
@Controller('plugins')
export class PluginController {
	@Get()
	async getPlugins(@Query('type') type?: PluginType) {
		// 返回插件列表
	}

	@Post(':name/enable')
	async enablePlugin(@Param('name') name: string) {
		// 启用插件
	}

	// ... 其他端点
}
```

**步骤 4.6**: 更新现有插件

```typescript
// libs/auth/src/lib/auth.plugin.ts
export class AuthPlugin implements IPlugin {
	readonly name: string = 'auth';
	readonly type: PluginType = PluginType.SYSTEM;
	readonly priority: PluginPriority = PluginPriority.P0;
	readonly isProtected: boolean = true;
	// ... 其他属性
}
```

**步骤 4.7**: 编写测试

```typescript
// libs/plugin/src/services/plugin-registry.service.spec.ts
describe('PluginRegistryService', () => {
	it('should register plugin', () => {
		// 测试逻辑
	});

	it('should prevent disabling system plugin', () => {
		// 测试逻辑
	});
});
```

#### 验收标准

-   ✅ 插件分类枚举定义正确
-   ✅ IPlugin 接口完整
-   ✅ PluginRegistryService 实现所有方法
-   ✅ PluginLoaderService 实现所有方法
-   ✅ PluginController 提供所有 API 端点
-   ✅ 8 个系统插件正确标记为 protected
-   ✅ 插件系统测试通过
-   ✅ 代码符合 AGENTS.md 规范

---

### 任务 5: 测试策略实施

**预估工时**: 8-10 小时
**优先级**: P1
**状态**: 待开始

#### 子任务

| 子任务            | 工时 | 描述                     |
| ----------------- | ---- | ------------------------ |
| 5.1 编写单元测试  | 4.0h | 核心业务逻辑 80%+ 覆盖率 |
| 5.2 编写集成测试  | 2.0h | 认证、插件、多租户流程   |
| 5.3 编写 E2E 测试 | 2.0h | 完整工作流测试           |
| 5.4 配置测试环境  | 1.0h | Jest 配置和测试数据库    |

#### 测试覆盖目标

| 模块                | 目标覆盖率 | 优先级 |
| ------------------- | ---------- | ------ |
| @oksai/auth         | 85%+       | P0     |
| @oksai/tenant       | 85%+       | P0     |
| @oksai/user         | 85%+       | P0     |
| @oksai/organization | 80%+       | P0     |
| @oksai/role         | 80%+       | P0     |
| @oksai/plugin       | 85%+       | P0     |
| @oksai/audit        | 80%+       | P1     |
| @oksai/analytics    | 80%+       | P1     |
| @oksai/reporting    | 75%+       | P1     |

#### 详细步骤

**步骤 5.1**: 编写单元测试

```typescript
// libs/auth/src/lib/auth.service.spec.ts
describe('AuthService', () => {
	let service: AuthService;
	let userRepo: Repository<User>;

	beforeEach(async () => {
		// 设置测试环境
	});

	describe('login', () => {
		it('should login with valid credentials', async () => {
			// 测试登录逻辑
		});

		it('should throw error with invalid credentials', async () => {
			// 测试错误处理
		});
	});
});
```

**步骤 5.2**: 编写集成测试

```typescript
// tests/integration/auth.integration.spec.ts
describe('Auth Integration', () => {
	let app: INestApplication;

	beforeAll(async () => {
		// 启动测试应用
	});

	describe('Login Flow', () => {
		it('should complete full login flow', async () => {
			// 1. 注册用户
			// 2. 验证邮箱
			// 3. 登录
			// 4. 获取令牌
		});
	});
});
```

**步骤 5.3**: 编写 E2E 测试

```typescript
// tests/e2e/user-workflow.e2e-spec.ts
describe('User Workflow E2E', () => {
	it('should complete user onboarding', async () => {
		// 1. 用户注册
		// 2. 创建租户
		// 3. 创建组织
		// 4. 邀请用户
		// 5. 接受邀请
		// 6. 验证数据
	});
});
```

**步骤 5.4**: 配置测试环境

```typescript
// jest.config.ts
export default {
	preset: 'ts-jest',
	testEnvironment: 'node',
	roots: ['<rootDir>/libs', '<rootDir>/tests'],
	testMatch: ['**/*.spec.ts', '**/*.integration.spec.ts'],
	collectCoverageFrom: ['libs/*/src/lib/**/*.ts', '!**/*.spec.ts', '!**/*.dto.ts', '!**/interfaces/**'],
	coverageThreshold: {
		global: {
			branches: 75,
			functions: 75,
			lines: 80,
			statements: 80
		}
	}
};
```

#### 验收标准

-   ✅ 核心业务逻辑覆盖率达到 80%+
-   ✅ 关键路径覆盖率达到 90%+
-   ✅ 所有公共 API 都有测试
-   ✅ 单元测试通过
-   ✅ 集成测试通过
-   ✅ E2E 测试通过
-   ✅ 代码符合 AGENTS.md 规范

---

### 任务 6: 配置与构建优化

**预估工时**: 2-3 小时
**优先级**: P1
**状态**: 待开始

#### 子任务

| 子任务                 | 工时 | 描述             |
| ---------------------- | ---- | ---------------- |
| 6.1 完善 MikroORM 配置 | 0.5h | 多数据库支持     |
| 6.2 配置环境变量       | 0.5h | .env.example     |
| 6.3 运行类型检查       | 0.5h | 修复类型错误     |
| 6.4 运行 Lint          | 0.5h | 修复代码风格问题 |
| 6.5 运行构建           | 0.5h | 确保构建成功     |

#### 详细步骤

**步骤 6.1**: 完善 MikroORM 配置

```typescript
// apps/base-api/src/config/mikro-orm.config.ts
export default MikroOrmModule.forRoot({
	entities: ['dist/**/*.entity.js'],
	dbName: process.env.DB_NAME || 'oksai',
	type: process.env.DB_TYPE || 'postgresql',
	host: process.env.DB_HOST || 'localhost',
	port: parseInt(process.env.DB_PORT || '5432'),
	user: process.env.DB_USER || 'postgres',
	password: process.env.DB_PASSWORD || 'postgres',
	migrations: {
		path: './migrations',
		pathTs: './migrations'
	}
});
```

**步骤 6.2**: 配置环境变量

```env
# .env.example
# Database
DB_TYPE=postgresql
DB_HOST=localhost
DB_PORT=5432
DB_NAME=oksai
DB_USER=postgres
DB_PASSWORD=postgres

# JWT
JWT_SECRET=
JWT_EXPIRY=7d
JWT_REFRESH_SECRET=
JWT_REFRESH_EXPIRY=30d

# OAuth Providers
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=
GOOGLE_CALLBACK_URL=

MICROSOFT_CLIENT_ID=
MICROSOFT_CLIENT_SECRET=
MICROSOFT_CALLBACK_URL=

# Plugin Settings
ENABLE_PLUGINS_HOT_RELOAD=true
```

**步骤 6.3-6.5**: 运行检查和构建

```bash
# 类型检查
pnpm run typecheck

# Lint
pnpm run lint

# 构建
pnpm run build

# 测试
pnpm test --coverage
```

#### 验收标准

-   ✅ MikroORM 配置支持多数据库
-   ✅ 环境变量配置完整
-   ✅ 类型检查通过
-   ✅ Lint 通过
-   ✅ 构建成功
-   ✅ 测试通过

---

### 任务 7: 文档完善

**预估工时**: 2-3 小时
**优先级**: P2
**状态**: 待开始

#### 子任务

| 子任务                | 工时 | 描述              |
| --------------------- | ---- | ----------------- |
| 7.1 编写插件开发文档  | 1.0h | 插件系统指南      |
| 7.2 配置 Swagger 文档 | 0.5h | 自动生成 API 文档 |
| 7.3 编写部署文档      | 1.0h | 部署指南          |

#### 详细步骤

**步骤 7.1**: 编写插件开发文档

```markdown
# docs/spec-plan/PLUGIN_DEVELOPMENT.md

## 插件开发指南

### 创建插件

\`\`\`typescript
import { IPlugin, PluginType, PluginPriority } from '@oksai/plugin';

export class MyPlugin implements IPlugin {
readonly name: string = 'my-plugin';
readonly type: PluginType = PluginType.BUSINESS;
readonly priority: PluginPriority = PluginPriority.P1;
readonly isProtected: boolean = false;

async onPluginBootstrap(): Promise<void> {
console.log('MyPlugin initialized');
}

async onPluginDestroy(): Promise<void> {
console.log('MyPlugin destroyed');
}
}
\`\`\`

### 注册插件

\`\`\`typescript
@Module({
providers: [MyPlugin]
})
export class AppModule {
constructor(private readonly registry: PluginRegistryService) {
registry.registerPlugin(new MyPlugin());
}
}
\`\`\`
```

**步骤 7.2**: 配置 Swagger 文档

```typescript
// apps/base-api/src/main.ts
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';

async function bootstrap() {
	const app = await NestFactory.create(AppModule);

	const config = new DocumentBuilder().setTitle('OKSAI API').setVersion('1.0').build();

	const document = SwaggerModule.createDocument(app, config);
	SwaggerModule.setup('api/docs', app, document);

	await app.listen(3000);
}
```

**步骤 7.3**: 编写部署文档

```markdown
# docs/spec-plan/DEPLOYMENT.md

## 部署指南

### 前置要求

-   Node.js >= 20.0.0
-   PostgreSQL >= 15
-   pnpm >= 9.0.0

### 部署步骤

1. 克隆仓库
2. 安装依赖
3. 配置环境变量
4. 运行数据库迁移
5. 启动应用
```

#### 验收标准

-   ✅ 插件开发文档完整
-   ✅ Swagger 文档可访问
-   ✅ 部署文档详细
-   ✅ 代码符合 AGENTS.md 规范

---

## 4. 实施顺序

### 第一批: 核心基础 (P0 优先级)

**时间**: 第 1-2 天
**目标**: 建立核心基础架构

1. **任务 2: 简化 ORM 层** (4-5h)

    - 替换 MultiORM 装饰器
    - 移除 TypeORM 依赖
    - 确保只使用 MikroORM

2. **任务 3: 简化数据库模型** (3-4h)

    - 确定核心实体清单
    - 复制并简化 15 个核心实体
    - 配置 MikroORM

3. **任务 4: 完善插件系统** (6-8h)
    - 实现插件分类和接口
    - 实现插件注册和加载服务
    - 更新 8 个系统插件

### 第二批: 功能完善 (P1 优先级)

**时间**: 第 3-4 天
**目标**: 完善核心功能

4. **任务 1: 添加 Microsoft 认证** (2-3h)

    - 复制 Microsoft 认证代码
    - 更新认证服务

5. **任务 6: 配置与构建优化** (2-3h)
    - 完善 MikroORM 配置
    - 配置环境变量
    - 修复类型和构建错误

### 第三批: 测试验证 (P1-P2 优先级)

**时间**: 第 4-5 天
**目标**: 建立完整测试体系

6. **任务 5: 测试策略实施** (8-10h)

    - 编写单元测试
    - 编写集成测试
    - 编写 E2E 测试

7. **任务 7: 文档完善** (2-3h)
    - 插件开发文档
    - API 文档
    - 部署文档

---

## 5. 依赖关系

### 5.1 任务依赖图

```
任务 2 (简化 ORM 层)
    ├── 任务 3 (简化数据库模型)
    │   ├── 任务 4 (完善插件系统)
    │   │   ├── 任务 1 (添加 Microsoft 认证)
    │   │   │   └── 任务 5 (测试策略实施)
    │   │       └── 任务 6 (配置与构建优化)
    │   └── 任务 7 (文档完善)
```

### 5.2 依赖说明

| 任务   | 依赖任务 | 依赖原因                               |
| ------ | -------- | -------------------------------------- |
| 任务 3 | 任务 2   | 需要先简化 ORM，才能正确配置实体       |
| 任务 4 | 任务 3   | 插件系统需要基于核心实体构建           |
| 任务 1 | 任务 2   | Microsoft 认证需要使用 MikroORM 装饰器 |
| 任务 5 | 任务 1-4 | 测试需要在功能实现后编写               |
| 任务 6 | 任务 5   | 配置优化需要确保测试通过               |
| 任务 7 | 任务 4-6 | 文档需要在功能完成后编写               |

---

## 6. 验收标准

### 6.1 整体验收标准

#### 功能验收

-   ✅ Microsoft 认证正常工作
-   ✅ 所有第三方认证（Google、GitHub、Auth0）正常工作
-   ✅ 插件系统支持热拔插
-   ✅ 系统插件不能被禁用或卸载
-   ✅ 业务插件可以启用、禁用、重载
-   ✅ 多租户数据隔离正常工作
-   ✅ 用户邀请流程正常工作

#### 代码质量验收

-   ✅ 所有代码符合 AGENTS.md 规范
-   ✅ 所有注释和错误消息使用中文
-   ✅ Git 提交信息使用英文
-   ✅ 所有公共 API 包含完整的 TSDoc 注释
-   ✅ 类型检查通过
-   ✅ Lint 通过
-   ✅ 构建成功

#### 测试验收

-   ✅ 核心业务逻辑测试覆盖率达到 80%+
-   ✅ 关键路径测试覆盖率达到 90%+
-   ✅ 所有公共 API 都有测试用例
-   ✅ 单元测试通过
-   ✅ 集成测试通过
-   ✅ E2E 测试通过

#### 性能验收

-   ✅ 应用启动时间 < 10 秒
-   ✅ API 响应时间 < 500ms (P95)
-   ✅ 数据库查询优化（使用索引）
-   ✅ 无内存泄漏

#### 文档验收

-   ✅ Swagger API 文档可访问
-   ✅ 插件开发文档完整
-   ✅ 部署文档详细
-   ✅ 代码注释完整

### 6.2 各任务验收标准

各任务的验收标准已在 [任务分解](#3-任务分解) 部分详细说明。

---

## 7. 风险与缓解

### 7.1 技术风险

| 风险                 | 影响 | 概率 | 缓解措施                             |
| -------------------- | ---- | ---- | ------------------------------------ |
| ORM 简化引入 Bug     | 高   | 中   | 充分的单元测试，分步实施             |
| 实体简化导致数据丢失 | 高   | 低   | 备份现有数据，仔细测试迁移           |
| 插件依赖冲突         | 中   | 中   | 实现依赖检查机制，测试插件加载       |
| 类型错误数量多       | 中   | 高   | 使用自动化工具，逐步修复             |
| 测试覆盖率不达标     | 中   | 中   | 优先编写核心逻辑测试，使用覆盖率工具 |

### 7.2 进度风险

| 风险         | 影响 | 概率 | 缓解措施                   |
| ------------ | ---- | ---- | -------------------------- |
| 工作量低估   | 高   | 中   | 保留 20% 的缓冲时间        |
| 任务依赖阻塞 | 中   | 中   | 并行开发无依赖任务         |
| 测试耗时过长 | 中   | 高   | 优先编写关键测试，逐步扩展 |

### 7.3 质量风险

| 风险           | 影响 | 概率 | 缓解措施                     |
| -------------- | ---- | ---- | ---------------------------- |
| 代码规范不一致 | 中   | 高   | 严格遵循 AGENTS.md，代码审查 |
| 文档不完整     | 低   | 中   | 边开发边更新文档             |
| 性能问题       | 中   | 低   | 性能测试，数据库优化         |

---

## 8. 里程碑

### 里程碑 1: 核心基础完成

**日期**: 第 2 天结束
**验收标准**:

-   ✅ 任务 2 完成（ORM 层简化）
-   ✅ 任务 3 完成（数据库模型简化）
-   ✅ 任务 4 完成（插件系统完善）

**可交付物**:

-   纯 MikroORM 实现的实体
-   完整的插件系统框架
-   15 个核心实体

### 里程碑 2: 功能完善完成

**日期**: 第 4 天结束
**验收标准**:

-   ✅ 任务 1 完成（Microsoft 认证）
-   ✅ 任务 6 完成（配置与构建优化）

**可交付物**:

-   Microsoft 认证功能
-   完整的环境配置
-   可构建的代码

### 里程碑 3: 测试体系建立

**日期**: 第 5 天结束
**验收标准**:

-   ✅ 任务 5 完成（测试策略实施）

**可交付物**:

-   单元测试套件（80%+ 覆盖率）
-   集成测试套件
-   E2E 测试套件

### 里程碑 4: 项目完成

**日期**: 第 6 天结束
**验收标准**:

-   ✅ 任务 7 完成（文档完善）
-   ✅ 所有整体验收标准满足

**可交付物**:

-   完整的 OKSAI SAAS 服务端框架
-   插件开发文档
-   API 文档（Swagger）
-   部署文档

---

## 附录

### A. 术语表

| 术语     | 定义                                          |
| -------- | --------------------------------------------- |
| P0-P3    | 优先级级别，P0 最高，P3 最低                  |
| TSDoc    | TypeScript Documentation，TypeScript 文档规范 |
| E2E      | End-to-End，端到端测试                        |
| RBAC     | Role-Based Access Control，基于角色的访问控制 |
| Hot-swap | 热拔插，不需要重启应用即可加载/卸载插件       |

### B. 参考文档

-   01-技术规格文档.md - 本文档配套的技术规格
-   AGENTS.md - 代理指南和代码规范
-   CODING_STANDARDS.md - 代码规范
-   TESTING_GUIDE.md - 测试指南

### C. 变更历史

| 版本  | 日期       | 变更内容                                |
| ----- | ---------- | --------------------------------------- |
| 1.0.0 | 2026-02-07 | 初始版本                                |
| 1.1.0 | 2026-02-08 | 更新任务 1 状态为已完成，更新进度到 67% |

---

**文档结束**
