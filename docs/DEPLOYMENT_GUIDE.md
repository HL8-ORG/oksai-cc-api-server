# éƒ¨ç½²æŒ‡å—

## ğŸ“‘ ç›®å½•

-   [éƒ¨ç½²æ¦‚è¿°](#éƒ¨ç½²æ¦‚è¿°)
    -   [éƒ¨ç½²ç¯å¢ƒ](#éƒ¨ç½²ç¯å¢ƒ)
    -   [éƒ¨ç½²ç­–ç•¥](#éƒ¨ç½²ç­–ç•¥)
    -   [éƒ¨ç½²æµç¨‹](#éƒ¨ç½²æµç¨‹)
-   [ç¯å¢ƒé…ç½®](#ç¯å¢ƒé…ç½®)
    -   [å¼€å‘ç¯å¢ƒ](#å¼€å‘ç¯å¢ƒ)
    -   [æµ‹è¯•ç¯å¢ƒ](#æµ‹è¯•ç¯å¢ƒ)
    -   [ç”Ÿäº§ç¯å¢ƒ](#ç”Ÿäº§ç¯å¢ƒ)
-   [å®¹å™¨åŒ–éƒ¨ç½²](#å®¹å™¨åŒ–éƒ¨ç½²)
    -   [Docker æ„å»º](#docker-æ„å»º)
    -   [Docker Compose](#docker-compose)
    -   [Kubernetes éƒ¨ç½²](#kubernetes-éƒ¨ç½²)
-   [æ•°æ®åº“éƒ¨ç½²](#æ•°æ®åº“éƒ¨ç½²)
    -   [PostgreSQL éƒ¨ç½²](#postgresql-éƒ¨ç½²)
    -   [MongoDB éƒ¨ç½²](#mongodb-éƒ¨ç½²)
    -   [æ•°æ®åº“è¿ç§»](#æ•°æ®åº“è¿ç§»)
-   [åº”ç”¨éƒ¨ç½²](#åº”ç”¨éƒ¨ç½²)
    -   [æ„å»ºåº”ç”¨](#æ„å»ºåº”ç”¨)
    -   [å¯åŠ¨åº”ç”¨](#å¯åŠ¨åº”ç”¨)
    -   [å¥åº·æ£€æŸ¥](#å¥åº·æ£€æŸ¥)
-   [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
    -   [æ—¥å¿—æ”¶é›†](#æ—¥å¿—æ”¶é›†)
    -   [æŒ‡æ ‡ç›‘æ§](#æŒ‡æ ‡ç›‘æ§)
    -   [å‘Šè­¦é…ç½®](#å‘Šè­¦é…ç½®)
-   [æ°´å¹³æ‰©å±•](#æ°´å¹³æ‰©å±•)
    -   [æ— çŠ¶æ€è®¾è®¡](#æ— çŠ¶æ€è®¾è®¡)
    -   [è´Ÿè½½å‡è¡¡](#è´Ÿè½½å‡è¡¡)
    -   [è‡ªåŠ¨æ‰©å±•](#è‡ªåŠ¨æ‰©å±•)
-   [é«˜å¯ç”¨è®¾è®¡](#é«˜å¯ç”¨è®¾è®¡)
    -   [å†—ä½™éƒ¨ç½²](#å†—ä½™éƒ¨ç½²)
    -   [æ•…éšœè½¬ç§»](#æ•…éšœè½¬ç§»)
    -   [æ•°æ®å¤‡ä»½](#æ•°æ®å¤‡ä»½)
    -   [ç¾å¤‡æ¢å¤](#ç¾å¤‡æ¢å¤)
-   [æŒç»­é›†æˆå’Œéƒ¨ç½²](#æŒç»­é›†æˆå’Œéƒ¨ç½²)
    -   [CI/CD æµç¨‹](#cicd-æµç¨‹)
    -   [è‡ªåŠ¨åŒ–éƒ¨ç½²](#è‡ªåŠ¨åŒ–éƒ¨ç½²)
    -   [å›æ»šç­–ç•¥](#å›æ»šç­–ç•¥)
-   [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
    -   [åº”ç”¨ä¼˜åŒ–](#åº”ç”¨ä¼˜åŒ–)
    -   [æ•°æ®åº“ä¼˜åŒ–](#æ•°æ®åº“ä¼˜åŒ–)
    -   [ç¼“å­˜ä¼˜åŒ–](#ç¼“å­˜ä¼˜åŒ–)
    -   [ç½‘ç»œä¼˜åŒ–](#ç½‘ç»œä¼˜åŒ–)
-   [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)
    -   [ç½‘ç»œå®‰å…¨](#ç½‘ç»œå®‰å…¨)
    -   **æ•°æ®å®‰å…¨** (æ•°æ®å®‰å…¨)
    -   **è®¤è¯å®‰å…¨** (è®¤è¯å®‰å…¨)
    -   **å®¡è®¡æ—¥å¿—** (å®¡è®¡æ—¥å¿—)
-   **å¸¸è§é—®é¢˜** (å¸¸è§é—®é¢˜)
    -   **éƒ¨ç½²ç›¸å…³** (éƒ¨ç½²ç›¸å…³)
    -   **æ€§èƒ½ç›¸å…³** (æ€§èƒ½ç›¸å…³)
    -   **å®‰å…¨ç›¸å…³** (å®‰å…¨ç›¸å…³)

---

## éƒ¨ç½²æ¦‚è¿°

### éƒ¨ç½²ç¯å¢ƒ

OKSAI å¹³å°æ”¯æŒå¤šç§éƒ¨ç½²ç¯å¢ƒï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒã€‚

**ç¯å¢ƒç±»å‹ï¼š**

-   **å¼€å‘ç¯å¢ƒ** - ç”¨äºæœ¬åœ°å¼€å‘å’Œæµ‹è¯•
-   **æµ‹è¯•ç¯å¢ƒ** - ç”¨äºé›†æˆæµ‹è¯•å’Œç”¨æˆ·éªŒæ”¶æµ‹è¯•
-   **ç”Ÿäº§ç¯å¢ƒ** - ç”¨äºæ­£å¼ä¸Šçº¿è¿è¡Œ

### éƒ¨ç½²ç­–ç•¥

é‡‡ç”¨å¤šé˜¶æ®µéƒ¨ç½²ç­–ç•¥ï¼Œç¡®ä¿éƒ¨ç½²çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚

**éƒ¨ç½²ç­–ç•¥ï¼š**

-   **è“ç»¿éƒ¨ç½²** - åŒæ—¶ç»´æŠ¤ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå¿«é€Ÿåˆ‡æ¢
-   **æ»šåŠ¨æ›´æ–°** - é€æ­¥æ›´æ–°å®ä¾‹ï¼Œä¿è¯æœåŠ¡å¯ç”¨
-   **é‡‘ä¸é›€å‘å¸ƒ** - å…ˆå‘å°éƒ¨åˆ†ç”¨æˆ·å‘å¸ƒï¼ŒéªŒè¯åå†å…¨é¢æ¨å¹¿

### éƒ¨ç½²æµç¨‹

**éƒ¨ç½²æµç¨‹å›¾ï¼š**

```mermaid
graph TD
    A[å¼€å‘å®Œæˆ] --> B[ä»£ç å®¡æŸ¥]
    B --> C[åˆå¹¶åˆ°ä¸»åˆ†æ”¯]
    C --> D[æ„å»º Docker é•œåƒ]
    D --> E[æ¨é€åˆ°é•œåƒä»“åº“]
    E --> F[éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ]
    F --> G[è¿è¡Œæµ‹è¯•]
    G --> H{æµ‹è¯•é€šè¿‡?}
    H -->|æ˜¯| I[éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ]
    H -->|å¦| A
    I --> J[å¥åº·æ£€æŸ¥]
    J --> K{å¥åº·æ£€æŸ¥é€šè¿‡?}
    K -->|æ˜¯| L[å®Œæˆéƒ¨ç½²]
    K -->|å¦| M[å›æ»š]
```

---

## ç¯å¢ƒé…ç½®

### å¼€å‘ç¯å¢ƒ

å¼€å‘ç¯å¢ƒç”¨äºæœ¬åœ°å¼€å‘å’Œæµ‹è¯•ï¼Œä½¿ç”¨ Docker Compose å¿«é€Ÿå¯åŠ¨ã€‚

**å¼€å‘ç¯å¢ƒé…ç½®ï¼š**

```bash
# .env.development
NODE_ENV=development
PORT=3000
API_PREFIX=api

# æ•°æ®åº“é…ç½®
DB_TYPE=postgres
DB_HOST=localhost
DB_PORT=5432
DB_NAME=oksai_dev
DB_USER=postgres
DB_PASSWORD=postgres

# JWT é…ç½®
JWT_SECRET=dev-secret-change-in-production
JWT_REFRESH_SECRET=dev-refresh-secret-change-in-production
JWT_EXPIRES_IN=1d
JWT_REFRESH_EXPIRES_IN=7d

# Redis é…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0
```

### æµ‹è¯•ç¯å¢ƒ

æµ‹è¯•ç¯å¢ƒç”¨äºé›†æˆæµ‹è¯•å’Œç”¨æˆ·éªŒæ”¶æµ‹è¯•ï¼Œæ¨¡æ‹Ÿç”Ÿäº§ç¯å¢ƒé…ç½®ã€‚

**æµ‹è¯•ç¯å¢ƒé…ç½®ï¼š**

```bash
# .env.test
NODE_ENV=test
PORT=3000
API_PREFIX=api

# æ•°æ®åº“é…ç½®
DB_TYPE=postgres
DB_HOST=test-db.example.com
DB_PORT=5432
DB_NAME=oksai_test
DB_USER=oksai_test
DB_PASSWORD=secure_password

# JWT é…ç½®
JWT_SECRET=test-secret
JWT_REFRESH_SECRET=test-refresh-secret
JWT_EXPIRES_IN=1d
JWT_REFRESH_EXPIRES_IN=7d

# Redis é…ç½®
REDIS_HOST=test-redis.example.com
REDIS_PORT=6379
REDIS_PASSWORD=secure_password
REDIS_DB=0
```

### ç”Ÿäº§ç¯å¢ƒ

ç”Ÿäº§ç¯å¢ƒç”¨äºæ­£å¼ä¸Šçº¿è¿è¡Œï¼Œä½¿ç”¨é«˜å¯ç”¨é…ç½®å’Œå®‰å…¨é…ç½®ã€‚

**ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š**

```bash
# .env.production
NODE_ENV=production
PORT=3000
API_PREFIX=api

# æ•°æ®åº“é…ç½®
DB_TYPE=postgres
DB_HOST=prod-db.example.com
DB_PORT=5432
DB_NAME=oksai_prod
DB_USER=oksai_prod
DB_PASSWORD=very_secure_password

# JWT é…ç½®
JWT_SECRET=your-very-secure-random-jwt-access-secret-at-least-32-characters-long
JWT_REFRESH_SECRET=your-very-secure-random-jwt-refresh-secret-at-least-32-characters-long
JWT_EXPIRES_IN=1h
JWT_REFRESH_EXPIRES_IN=7d

# Redis é…ç½®
REDIS_HOST=prod-redis.example.com
REDIS_PORT=6379
REDIS_PASSWORD=very_secure_redis_password
REDIS_DB=0

# OAuth é…ç½®
GOOGLE_CLIENT_ID=your-production-google-client-id
GOOGLE_CLIENT_SECRET=your-production-google-client-secret
GITHUB_CLIENT_ID=your-production-github-client-id
GITHUB_CLIENT_SECRET=your-production-github-client-secret

# é‚®ä»¶é…ç½®
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=noreply@oksai.io
SMTP_PASS=secure_smtp_password

# API é…ç½®
API_BASE_URL=https://api.oksai.io
CLIENT_BASE_URL=https://app.oksai.io

# é‚®ä»¶å‘Šè­¦é…ç½®
ADMIN_EMAIL=admin@oksai.io
```

---

## å®¹å™¨åŒ–éƒ¨ç½²

### Docker æ„å»º

ä½¿ç”¨ Docker æ„å»ºåº”ç”¨é•œåƒã€‚

**Dockerfileï¼š**

```dockerfile
FROM node:20-alpine

WORKDIR /app

# å¤åˆ¶ package.json å’Œ pnpm-lock.yaml
COPY package.json pnpm-lock.yaml ./

# å®‰è£… pnpm
RUN npm install -g pnpm@10.11.0

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºåº”ç”¨
RUN pnpm run build

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨åº”ç”¨
CMD ["node", "dist/main.js"]
```

**æ„å»ºé•œåƒï¼š**

```bash
# æ„å»ºé•œåƒ
docker build -t oksai-api:latest .

# æ„å»ºç”Ÿäº§é•œåƒ
docker build -t oksai-api:1.0.0 .
```

### Docker Compose

ä½¿ç”¨ Docker Compose å¿«é€Ÿå¯åŠ¨å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚

**docker-compose.ymlï¼š**

```yaml
version: '3.8'

services:
    postgres:
        image: postgres:15-alpine
        container_name: oksai-postgres
        environment:
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
            POSTGRES_DB: oksai_dev
        ports:
            - '5432:5432'
        volumes:
            - postgres_data:/var/lib/postgresql/data

    redis:
        image: redis:7-alpine
        container_name: oksai-redis
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data

    api:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: oksai-api
        environment:
            NODE_ENV: development
            DB_HOST: postgres
            DB_PORT: 5432
            DB_NAME: oksai_dev
            DB_USER: postgres
            DB_PASSWORD: postgres
            REDIS_HOST: redis
            REDIS_PORT: 6379
        ports:
            - '3000:3000'
        depends_on:
            - postgres
            - redis
        volumes:
            - .:/app
            - /app/node_modules

volumes:
    postgres_data:
    redis_data:
```

**å¯åŠ¨æœåŠ¡ï¼š**

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down
```

### Kubernetes éƒ¨ç½²

ä½¿ç”¨ Kubernetes è¿›è¡Œç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€‚

**Deployment é…ç½®ï¼š**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: oksai-api
    labels:
        app: oksai-api
spec:
    replicas: 3
    selector:
        matchLabels:
            app: oksai-api
    template:
        metadata:
            labels:
                app: oksai-api
        spec:
            containers:
                - name: oksai-api
                  image: oksai-api:1.0.0
                  ports:
                      - containerPort: 3000
                  env:
                      - name: NODE_ENV
                        value: 'production'
                      - name: DB_HOST
                        valueFrom:
                            secretKeyRef:
                                name: oksai-secrets
                                key: db-host
                      - name: DB_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: oksai-secrets
                                key: db-password
                  resources:
                      requests:
                          memory: '256Mi'
                          cpu: '250m'
                      limits:
                          memory: '512Mi'
                          cpu: '500m'
                  livenessProbe:
                      httpGet:
                          path: /api/v1/health
                          port: 3000
                      initialDelaySeconds: 30
                      periodSeconds: 10
                  readinessProbe:
                      httpGet:
                          path: /api/v1/health
                          port: 3000
                      initialDelaySeconds: 5
                      periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
    name: oksai-api
spec:
    selector:
        app: oksai-api
    ports:
        - protocol: TCP
          port: 80
          targetPort: 3000
    type: LoadBalancer
```

**éƒ¨ç½²å‘½ä»¤ï¼š**

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace oksai

# åº”ç”¨é…ç½®
kubectl apply -f k8s/deployment.yaml -n oksai

# æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
kubectl get pods -n oksai

# æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/oksai-api -n oksai
```

---

## æ•°æ®åº“éƒ¨ç½²

### PostgreSQL éƒ¨ç½²

**PostgreSQL é…ç½®ï¼š**

```yaml
# postgres-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: postgres
spec:
    replicas: 1
    selector:
        matchLabels:
            app: postgres
    template:
        metadata:
            labels:
                app: postgres
        spec:
            containers:
                - name: postgres
                  image: postgres:15-alpine
                  env:
                      - name: POSTGRES_DB
                        value: oksai_prod
                      - name: POSTGRES_USER
                        valueFrom:
                            secretKeyRef:
                                name: postgres-secrets
                                key: username
                      - name: POSTGRES_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: postgres-secrets
                                key: password
                  ports:
                      - containerPort: 5432
                  volumeMounts:
                      - name: postgres-storage
                        mountPath: /var/lib/postgresql/data
            volumes:
                - name: postgres-storage
                  persistentVolumeClaim:
                      claimName: postgres-pvc
---
apiVersion: v1
kind: Service
metadata:
    name: postgres
spec:
    selector:
        app: postgres
    ports:
        - port: 5432
    clusterIP: None
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
    name: postgres-pvc
spec:
    accessModes:
        - ReadWriteOnce
    resources:
        requests:
            storage: 10Gi
```

### MongoDB éƒ¨ç½²

**MongoDB é…ç½®ï¼š**

```yaml
# mongodb-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
    name: mongodb
spec:
    replicas: 1
    selector:
        matchLabels:
            app: mongodb
    template:
        metadata:
            labels:
                app: mongodb
        spec:
            containers:
                - name: mongodb
                  image: mongo:7
                  env:
                      - name: MONGO_INITDB_ROOT_USERNAME
                        valueFrom:
                            secretKeyRef:
                                name: mongodb-secrets
                                key: username
                      - name: MONGO_INITDB_ROOT_PASSWORD
                        valueFrom:
                            secretKeyRef:
                                name: mongodb-secrets
                                key: password
                      - name: MONGO_INITDB_DATABASE
                        value: oksai_prod
                  ports:
                      - containerPort: 27017
                  volumeMounts:
                      - name: mongodb-storage
                        mountPath: /data/db
            volumes:
                - name: mongodb-storage
                  persistentVolumeClaim:
                      claimName: mongodb-pvc
---
apiVersion: v1
kind: Service
metadata:
    name: mongodb
spec:
    selector:
        app: mongodb
    ports:
        - port: 27017
    clusterIP: None
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
    name: mongodb-pvc
spec:
    accessModes:
        - ReadWriteOnce
    resources:
        requests:
            storage: 10Gi
```

### æ•°æ®åº“è¿ç§»

**è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š**

```bash
# å¼€å‘ç¯å¢ƒè¿ç§»
pnpm migration:run

# ç”Ÿäº§ç¯å¢ƒè¿ç§»
NODE_ENV=production pnpm migration:run

# ä½¿ç”¨ Docker è¿è¡Œè¿ç§»
docker-compose exec api pnpm migration:run

# ä½¿ç”¨ Kubernetes è¿è¡Œè¿ç§»
kubectl exec -it deployment/oksai-api -n oksai -- pnpm migration:run
```

---

## åº”ç”¨éƒ¨ç½²

### æ„å»ºåº”ç”¨

**æ„å»ºå‘½ä»¤ï¼š**

```bash
# å¼€å‘ç¯å¢ƒæ„å»º
pnpm run build

# ç”Ÿäº§ç¯å¢ƒæ„å»º
NODE_ENV=production pnpm run build

# Docker æ„å»º
docker build -t oksai-api:latest .
```

### å¯åŠ¨åº”ç”¨

**å¯åŠ¨å‘½ä»¤ï¼š**

```bash
# å¼€å‘ç¯å¢ƒå¯åŠ¨
cd apps/base-api && pnpm run start:dev

# ç”Ÿäº§ç¯å¢ƒå¯åŠ¨
cd apps/base-api && pnpm run build && pnpm run start

# Docker å¯åŠ¨
docker run -p 3000:3000 oksai-api:latest

# Kubernetes å¯åŠ¨
kubectl apply -f k8s/deployment.yaml
```

### å¥åº·æ£€æŸ¥

**å¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼š**

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/v1/health

# å“åº”ç¤ºä¾‹
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-01-01T00:00:00.000Z",
    "version": "1.0.0",
    "environment": "production",
    "uptime": 3600
  }
}
```

---

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—æ”¶é›†

**æ—¥å¿—æ”¶é›†ç­–ç•¥ï¼š**

```mermaid
graph TD
    A[åº”ç”¨æ—¥å¿—] --> B[æ—¥å¿—ä»£ç†]
    B --> C[æ—¥å¿—å­˜å‚¨]
    C --> D[æ—¥å¿—åˆ†æ]

    A --> E[æ§åˆ¶å°è¾“å‡º]
    E --> F[æ—¥å¿—è½¬å‘]

    A --> G[æ—¥å¿—æ–‡ä»¶]
    G --> H[æ—¥å¿—è½®è½¬]
```

**æ—¥å¿—é…ç½®ï¼š**

```typescript
import { WinstonModule } from 'nest-winston';

@Module({
    imports: [
        WinstonModule.forRoot({
            transports: [
                new winston.transports.Console({
                    format: winston.format.combine(
                        winston.format.timestamp(),
                        winston.format.colorize(),
                        winston.format.printf(({ timestamp, level, message }) => {
                            return `${timestamp} [${level}]: ${message}`;
                        })
                    )
                }),
                new winston.transports.File({
                    filename: 'logs/error.log',
                    level: 'error'
                }),
                new winston.transports.File({
                    filename: 'logs/combined.log'
                })
            ]
        })
    ]
})
```

### æŒ‡æ ‡ç›‘æ§

**æŒ‡æ ‡ç›‘æ§æ¶æ„ï¼š**

```mermaid
graph TD
    A[åº”ç”¨] --> B[Prometheus]
    B --> C[Grafana]

    A --> D[åº”ç”¨æŒ‡æ ‡]
    D --> B

    A --> E[ç³»ç»ŸæŒ‡æ ‡]
    E --> F[Node Exporter]
    F --> B
```

**Prometheus é…ç½®ï¼š**

```yaml
# prometheus.yml
global:
    scrape_interval: 15s

scrape_configs:
    - job_name: 'oksai-api'
      metrics_path: '/metrics'
      static_configs:
          - targets: ['oksai-api:3000']

    - job_name: 'postgres'
      static_configs:
          - targets: ['postgres-exporter:9187']

    - job_name: 'redis'
      static_configs:
          - targets: ['redis-exporter:9121']
```

### å‘Šè­¦é…ç½®

**å‘Šè­¦è§„åˆ™ï¼š**

```yaml
# alerting.yml
groups:
    - name: oksai-api
      interval: 30s
      rules:
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
            for: 5m
            labels:
                severity: critical
            annotations:
                summary: 'é«˜é”™è¯¯ç‡'
                description: 'é”™è¯¯ç‡è¶…è¿‡ 10%'

          - alert: HighMemoryUsage
            expr: process_resident_memory_bytes / 1024 / 1024 > 512
            for: 5m
            labels:
                severity: warning
            annotations:
                summary: 'å†…å­˜ä½¿ç”¨ç‡é«˜'
                description: 'å†…å­˜ä½¿ç”¨è¶…è¿‡ 512MB'
```

---

## æ°´å¹³æ‰©å±•

### æ— çŠ¶æ€è®¾è®¡

**æ— çŠ¶æ€è®¾è®¡åŸåˆ™ï¼š**

-   åº”ç”¨æ— çŠ¶æ€ï¼Œå¯ä»¥éšæ„æ‰©å±•
-   ä¼šè¯çŠ¶æ€å­˜å‚¨åœ¨å¤–éƒ¨ï¼ˆRedisï¼‰
-   æ–‡ä»¶å­˜å‚¨åœ¨å¯¹è±¡å­˜å‚¨ï¼ˆS3ï¼‰

### è´Ÿè½½å‡è¡¡

**è´Ÿè½½å‡è¡¡æ¶æ„ï¼š**

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[è´Ÿè½½å‡è¡¡å™¨]
    B --> C[åº”ç”¨å®ä¾‹ 1]
    B --> D[åº”ç”¨å®ä¾‹ 2]
    B --> E[åº”ç”¨å®ä¾‹ 3]

    C --> F[æ•°æ®åº“]
    D --> F
    E --> F
```

**Nginx é…ç½®ï¼š**

```nginx
upstream oksai-api {
    least_conn;
    server api-1:3000;
    server api-2:3000;
    server api-3:3000;
}

server {
    listen 80;
    server_name api.oksai.io;

    location / {
        proxy_pass http://oksai-api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

### è‡ªåŠ¨æ‰©å±•

**Kubernetes è‡ªåŠ¨æ‰©å±•ï¼š**

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
    name: oksai-api-hpa
spec:
    scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: oksai-api
    minReplicas: 3
    maxReplicas: 10
    metrics:
        - type: Resource
          resource:
              name: cpu
              target:
                  type: Utilization
                  averageUtilization: 70
        - type: Resource
          resource:
              name: memory
              target:
                  type: Utilization
                  averageUtilization: 80
```

---

## é«˜å¯ç”¨è®¾è®¡

### å†—ä½™éƒ¨ç½²

**å†—ä½™éƒ¨ç½²æ¶æ„ï¼š**

```mermaid
graph TD
    A[è´Ÿè½½å‡è¡¡å™¨ 1] --> B[åº”ç”¨å®ä¾‹ 1]
    A --> C[åº”ç”¨å®ä¾‹ 2]

    D[è´Ÿè½½å‡è¡¡å™¨ 2] --> B
    D --> C

    A <--> D

    E[ä¸»æ•°æ®åº“] --> F[ä»æ•°æ®åº“ 1]
    E --> G[ä»æ•°æ®åº“ 2]
```

### æ•…éšœè½¬ç§»

**æ•…éšœè½¬ç§»æµç¨‹ï¼š**

```mermaid
sequenceDiagram
    participant M as ä¸»æ•°æ®åº“
    participant S1 as ä»æ•°æ®åº“ 1
    participant S2 as ä»æ•°æ®åº“ 2
    participant A as åº”ç”¨

    A->>M: å†™å…¥è¯·æ±‚
    M-->>S1: å¤åˆ¶æ•°æ®
    M-->>S2: å¤åˆ¶æ•°æ®
    M->>A: å†™å…¥æˆåŠŸ

    Note over M,S1,S2: ä¸»æ•°æ®åº“æ•…éšœ

    A->>S1: å†™å…¥è¯·æ±‚
    S1->>A: å†™å…¥æˆåŠŸï¼ˆä¸»æ•°æ®åº“åˆ‡æ¢ä¸º S1ï¼‰
```

### æ•°æ®å¤‡ä»½

**å¤‡ä»½ç­–ç•¥ï¼š**

-   **å…¨é‡å¤‡ä»½** - æ¯å¤©å‡Œæ™¨è¿›è¡Œå…¨é‡å¤‡ä»½
-   **å¢é‡å¤‡ä»½** - æ¯å°æ—¶è¿›è¡Œå¢é‡å¤‡ä»½
-   **å¼‚åœ°å¤‡ä»½** - å¤‡ä»½æ•°æ®å­˜å‚¨åˆ°å¼‚åœ°
-   **å¤‡ä»½ä¿ç•™** - ä¿ç•™æœ€è¿‘ 30 å¤©çš„å¤‡ä»½

**å¤‡ä»½è„šæœ¬ï¼š**

```bash
#!/bin/bash

# æ•°æ®åº“å¤‡ä»½è„šæœ¬
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/postgres"
DB_NAME="oksai_prod"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å…¨é‡å¤‡ä»½
pg_dump -h postgres -U oksai_prod -d $DB_NAME > $BACKUP_DIR/$DB_NAME_$DATE.sql

# å‹ç¼©å¤‡ä»½
gzip $BACKUP_DIR/$DB_NAME_$DATE.sql

# ä¸Šä¼ åˆ° S3
aws s3 cp $BACKUP_DIR/$DB_NAME_$DATE.sql.gz s3://oksai-backups/postgres/
```

### ç¾å¤‡æ¢å¤

**ç¾å¤‡æ¢å¤æµç¨‹ï¼š**

```mermaid
graph TD
    A[ç¾éš¾å‘ç”Ÿ] --> B[å¯åŠ¨ç¾å¤‡ç³»ç»Ÿ]
    B --> C[æ¢å¤æ•°æ®åº“å¤‡ä»½]
    C --> D[å¯åŠ¨åº”ç”¨å®ä¾‹]
    D --> E[åˆ‡æ¢ DNS]
    E --> F[éªŒè¯æœåŠ¡å¯ç”¨æ€§]
    F --> G[ç¾å¤‡æ¢å¤å®Œæˆ]
```

---

## æŒç»­é›†æˆå’Œéƒ¨ç½²

### CI/CD æµç¨‹

**CI/CD æµç¨‹å›¾ï¼š**

```mermaid
graph TD
    A[æäº¤ä»£ç ] --> B[GitHub Actions]
    B --> C[è¿è¡Œæµ‹è¯•]
    C --> D[æ„å»ºé•œåƒ]
    D --> E[æ¨é€åˆ°é•œåƒä»“åº“]
    E --> F[éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ]
    F --> G[éªŒè¯æµ‹è¯•ç¯å¢ƒ]
    G --> H[éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ]
    H --> I[éªŒè¯ç”Ÿäº§ç¯å¢ƒ]
```

**GitHub Actions é…ç½®ï¼š**

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
    push:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: '20'
            - run: pnpm install
            - run: pnpm test

    build:
        needs: test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Build Docker image
              run: docker build -t oksai-api:${{ github.sha }} .

    deploy-test:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Deploy to test environment
              run: kubectl apply -f k8s/test-deployment.yaml

    deploy-prod:
        needs: deploy-test
        runs-on: ubuntu-latest
        if: github.ref == 'refs/heads/main'
        steps:
            - name: Deploy to production
              run: kubectl apply -f k8s/prod-deployment.yaml
```

### è‡ªåŠ¨åŒ–éƒ¨ç½²

**éƒ¨ç½²è‡ªåŠ¨åŒ–å·¥å…·ï¼š**

-   **GitHub Actions** - GitHub åŸç”Ÿ CI/CD
-   **GitLab CI/CD** - GitLab åŸç”Ÿ CI/CD
-   **Jenkins** - å¼€æºè‡ªåŠ¨åŒ–æœåŠ¡å™¨
-   **CircleCI** - äº‘ç«¯ CI/CD å¹³å°

### å›æ»šç­–ç•¥

**å›æ»šç­–ç•¥ï¼š**

-   **å¿«é€Ÿå›æ»š** - ä½¿ç”¨ Git ç‰ˆæœ¬æ§åˆ¶å¿«é€Ÿå›æ»š
-   **è“ç»¿éƒ¨ç½²** - åˆ‡æ¢åˆ°å¤‡ç”¨ç¯å¢ƒ
-   **æ»šåŠ¨å›æ»š** - é€æ­¥å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬

**å›æ»šå‘½ä»¤ï¼š**

```bash
# Git å›æ»š
git revert <commit-hash>
git push

# Kubernetes å›æ»š
kubectl rollout undo deployment/oksai-api

# Docker å›æ»š
docker run -p 3000:3000 oksai-api:previous-version
```

---

## æ€§èƒ½ä¼˜åŒ–

### åº”ç”¨ä¼˜åŒ–

**åº”ç”¨ä¼˜åŒ–ç­–ç•¥ï¼š**

-   **ä»£ç ä¼˜åŒ–** - ä¼˜åŒ–ç®—æ³•å’Œæ•°æ®ç»“æ„
-   **ç¼“å­˜ä¼˜åŒ–** - ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
-   **å¼‚æ­¥å¤„ç†** - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†è€—æ—¶ä»»åŠ¡
-   **è¿æ¥æ± ** - ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± 

### æ•°æ®åº“ä¼˜åŒ–

**æ•°æ®åº“ä¼˜åŒ–ç­–ç•¥ï¼š**

-   **ç´¢å¼•ä¼˜åŒ–** - åœ¨å¸¸ç”¨æŸ¥è¯¢å­—æ®µä¸Šåˆ›å»ºç´¢å¼•
-   **æŸ¥è¯¢ä¼˜åŒ–** - ä¼˜åŒ–æ…¢æŸ¥è¯¢
-   **åˆ†åº“åˆ†è¡¨** - åˆ†åº“åˆ†è¡¨å¤„ç†å¤§æ•°æ®é‡
-   **è¯»å†™åˆ†ç¦»** - ä½¿ç”¨è¯»å†™åˆ†ç¦»å‡è½»ä¸»åº“å‹åŠ›

### ç¼“å­˜ä¼˜åŒ–

**ç¼“å­˜ä¼˜åŒ–ç­–ç•¥ï¼š**

-   **å¤šçº§ç¼“å­˜** - ä½¿ç”¨å¤šçº§ç¼“å­˜æé«˜å‘½ä¸­ç‡
-   **ç¼“å­˜é¢„çƒ­** - å¯åŠ¨æ—¶é¢„åŠ è½½çƒ­ç‚¹æ•°æ®
-   **ç¼“å­˜æ›´æ–°** - ä½¿ç”¨ Write-Through ç­–ç•¥æ›´æ–°ç¼“å­˜
-   **ç¼“å­˜å¤±æ•ˆ** - åˆç†è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´

### ç½‘ç»œä¼˜åŒ–

**ç½‘ç»œä¼˜åŒ–ç­–ç•¥ï¼š**

-   **CDN åŠ é€Ÿ** - ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº
-   **HTTP/2** - ä½¿ç”¨ HTTP/2 æé«˜æ€§èƒ½
-   **å‹ç¼©** - ä½¿ç”¨ Gzip/Brotli å‹ç¼©å“åº”
-   **é•¿è¿æ¥** - ä½¿ç”¨é•¿è¿æ¥å‡å°‘æ¡æ‰‹å¼€é”€

---

## å®‰å…¨é…ç½®

### ç½‘ç»œå®‰å…¨

**ç½‘ç»œå®‰å…¨é…ç½®ï¼š**

-   **é˜²ç«å¢™** - é…ç½®é˜²ç«å¢™è§„åˆ™
-   **SSL/TLS** - ä½¿ç”¨ SSL/TLS åŠ å¯†é€šä¿¡
-   **HTTPS** - å¼ºåˆ¶ä½¿ç”¨ HTTPS
-   **CORS** - é…ç½® CORS ç­–ç•¥

### æ•°æ®å®‰å…¨

**æ•°æ®å®‰å…¨é…ç½®ï¼š**

-   **æ•°æ®åŠ å¯†** - åŠ å¯†æ•æ„Ÿæ•°æ®
-   **å¤‡ä»½åŠ å¯†** - åŠ å¯†å¤‡ä»½æ•°æ®
-   **è®¿é—®æ§åˆ¶** - æ§åˆ¶æ•°æ®åº“è®¿é—®
-   **å®¡è®¡æ—¥å¿—** - è®°å½•æ•°æ®è®¿é—®æ—¥å¿—

### è®¤è¯å®‰å…¨

**è®¤è¯å®‰å…¨é…ç½®ï¼š**

-   **å¼ºå¯†ç ç­–ç•¥** - å¼ºåˆ¶ä½¿ç”¨å¼ºå¯†ç 
-   **å¤šå› ç´ è®¤è¯** - æ”¯æŒå¤šå› ç´ è®¤è¯
-   **ä»¤ç‰Œè¿‡æœŸ** - è®¾ç½®åˆç†çš„ä»¤ç‰Œè¿‡æœŸæ—¶é—´
-   **ä»¤ç‰Œåˆ·æ–°** - æ”¯æŒä»¤ç‰Œåˆ·æ–°æœºåˆ¶

### å®¡è®¡æ—¥å¿—

**å®¡è®¡æ—¥å¿—é…ç½®ï¼š**

-   **æ“ä½œæ—¥å¿—** - è®°å½•æ‰€æœ‰å…³é”®æ“ä½œ
-   **è®¿é—®æ—¥å¿—** - è®°å½•æ‰€æœ‰ API è®¿é—®
-   **é”™è¯¯æ—¥å¿—** - è®°å½•æ‰€æœ‰é”™è¯¯ä¿¡æ¯
-   **æ€§èƒ½æ—¥å¿—** - è®°å½•æ€§èƒ½æŒ‡æ ‡

---

## å¸¸è§é—®é¢˜

### éƒ¨ç½²ç›¸å…³

**Q: å¦‚ä½•å¿«é€Ÿéƒ¨ç½²åº”ç”¨ï¼Ÿ**

A: ä½¿ç”¨ Docker Compose å¿«é€Ÿéƒ¨ç½²ï¼š

```bash
docker-compose up -d
```

**Q: å¦‚ä½•å‡çº§åº”ç”¨ç‰ˆæœ¬ï¼Ÿ**

A: ä½¿ç”¨ Kubernetes è¿›è¡Œæ»šåŠ¨å‡çº§ï¼š

```bash
kubectl set image deployment/oksai-api oksai-api=oksai-api:new-version
```

**Q: å¦‚ä½•æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼Ÿ**

A: ä½¿ç”¨ Kubernetes æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
kubectl logs -f deployment/oksai-api -n oksai
```

### æ€§èƒ½ç›¸å…³

**Q: å¦‚ä½•ä¼˜åŒ–åº”ç”¨æ€§èƒ½ï¼Ÿ**

A: å‚è€ƒ [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–) ç« èŠ‚ã€‚

**Q: å¦‚ä½•å¤„ç†é«˜å¹¶å‘ï¼Ÿ**

A: ä½¿ç”¨æ°´å¹³æ‰©å±•å’Œè´Ÿè½½å‡è¡¡ï¼š

```bash
kubectl scale deployment/oksai-api --replicas=10
```

### å®‰å…¨ç›¸å…³

**Q: å¦‚ä½•åŠ å¼ºåº”ç”¨å®‰å…¨ï¼Ÿ**

A: å‚è€ƒ [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®) ç« èŠ‚ã€‚

**Q: å¦‚ä½•å¤„ç†å®‰å…¨æ¼æ´ï¼Ÿ**

A: å®šæœŸæ›´æ–°ä¾èµ–ï¼Œä½¿ç”¨å®‰å…¨æ‰«æå·¥å…·ï¼š

```bash
npm audit fix
```

---

## ç‰ˆæœ¬ä¿¡æ¯

-   **æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0.0
-   **æœ€åæ›´æ–°ï¼š** 2026-02-04
-   **ç»´æŠ¤è€…ï¼š** OKSAI å¹³å°å›¢é˜Ÿ
