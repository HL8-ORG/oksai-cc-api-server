# æµ‹è¯•æŒ‡å—

## ğŸ“‘ ç›®å½•

-   [æµ‹è¯•æ¦‚è¿°](#æµ‹è¯•æ¦‚è¿°)
    -   [æµ‹è¯•é‡è¦æ€§](#æµ‹è¯•é‡è¦æ€§)
    -   [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
    -   [æµ‹è¯•è¦†ç›–ç‡è¦æ±‚](#æµ‹è¯•è¦†ç›–ç‡è¦æ±‚)
-   [å•å…ƒæµ‹è¯•](#å•å…ƒæµ‹è¯•)
    -   [æµ‹è¯•æ–‡ä»¶ä½ç½®](#æµ‹è¯•æ–‡ä»¶ä½ç½®)
    -   [æµ‹è¯•æ¡†æ¶](#æµ‹è¯•æ¡†æ¶)
    -   [æµ‹è¯•ç¤ºä¾‹](#æµ‹è¯•ç¤ºä¾‹)
    -   [æµ‹è¯•æœ€ä½³å®è·µ](#æµ‹è¯•æœ€ä½³å®è·µ)
-   [é›†æˆæµ‹è¯•](#é›†æˆæµ‹è¯•)
    -   [æµ‹è¯•æ–‡ä»¶ä½ç½®](#æµ‹è¯•æ–‡ä»¶ä½ç½®-1)
    -   [æµ‹è¯•æ¡†æ¶](#æµ‹è¯•æ¡†æ¶-1)
    -   [æµ‹è¯•ç¤ºä¾‹](#æµ‹è¯•ç¤ºä¾‹-1)
    -   [æµ‹è¯•æœ€ä½³å®è·µ](#æµ‹è¯•æœ€ä½³å®è·µ-1)
-   [ç«¯åˆ°ç«¯æµ‹è¯•](#ç«¯åˆ°ç«¯æµ‹è¯•)
    -   [æµ‹è¯•æ–‡ä»¶ä½ç½®](#æµ‹è¯•æ–‡ä»¶ä½ç½®-2)
    -   [æµ‹è¯•æ¡†æ¶](#æµ‹è¯•æ¡†æ¶-2)
    -   [æµ‹è¯•ç¤ºä¾‹](#æµ‹è¯•ç¤ºä¾‹-2)
    -   [æµ‹è¯•æœ€ä½³å®è·µ](#æµ‹è¯•æœ€ä½³å®è·µ-2)
-   [æµ‹è¯•å‘½ä»¤](#æµ‹è¯•å‘½ä»¤)
    -   [è¿è¡Œæ‰€æœ‰æµ‹è¯•](#è¿è¡Œæ‰€æœ‰æµ‹è¯•)
    -   [è¿è¡ŒæŒ‡å®šåŒ…çš„æµ‹è¯•](#è¿è¡ŒæŒ‡å®šåŒ…çš„æµ‹è¯•)
    -   [è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶](#è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶)
    -   [ç›‘å¬æ¨¡å¼è¿è¡Œæµ‹è¯•](#ç›‘å¬æ¨¡å¼è¿è¡Œæµ‹è¯•)
    -   [ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š](#ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š)
-   [æµ‹è¯•å·¥å…·](#æµ‹è¯•å·¥å…·)
    -   [Jest](#jest)
    -   [Supertest](#supertest)
    -   [æµ‹è¯•æ›¿èº«](#æµ‹è¯•æ›¿èº«)
-   [æµ‹è¯• CI/CD](#æµ‹è¯•-cicd)
    -   [æŒç»­é›†æˆ](#æŒç»­é›†æˆ)
    -   [æµ‹è¯•æŠ¥å‘Š](#æµ‹è¯•æŠ¥å‘Š)
    -   [æµ‹è¯•å¤±è´¥å¤„ç†](#æµ‹è¯•å¤±è´¥å¤„ç†)
-   [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
    -   [æµ‹è¯•ç›¸å…³](#æµ‹è¯•ç›¸å…³)
    -   [è¦†ç›–ç‡ç›¸å…³](#è¦†ç›–ç‡ç›¸å…³)
    -   [CI/CD ç›¸å…³](#cicd-ç›¸å…³)

---

## æµ‹è¯•æ¦‚è¿°

### æµ‹è¯•é‡è¦æ€§

æµ‹è¯•æ˜¯ç¡®ä¿è½¯ä»¶è´¨é‡çš„é‡è¦æ‰‹æ®µï¼Œå¯ä»¥åŠæ—©å‘ç°å’Œä¿®å¤ç¼ºé™·ï¼Œæé«˜ä»£ç çš„å¯é æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

**æµ‹è¯•çš„ä»·å€¼ï¼š**

-   **æå‰å‘ç°ç¼ºé™·** - åœ¨ä»£ç éƒ¨ç½²å‰å‘ç°å¹¶ä¿®å¤é—®é¢˜
-   **ä¿è¯ä»£ç è´¨é‡** - ç¡®ä¿ä»£ç ç¬¦åˆé¢„æœŸè¡Œä¸º
-   **æ”¯æŒé‡æ„** - åœ¨é‡æ„æ—¶ä¿è¯åŠŸèƒ½ä¸å—å½±å“
-   **æ–‡æ¡£ä½œç”¨** - æµ‹è¯•ç”¨ä¾‹å¯ä»¥ä½œä¸ºä»£ç çš„ä½¿ç”¨ç¤ºä¾‹
-   **æå‡ä¿¡å¿ƒ** - åœ¨å‘å¸ƒå‰ç»™äºˆå¼€å‘è€…å’Œå›¢é˜Ÿä¿¡å¿ƒ

### æµ‹è¯•ç­–ç•¥

é‡‡ç”¨åˆ†å±‚æµ‹è¯•ç­–ç•¥ï¼Œå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•å„å¸å…¶èŒï¼Œç¡®ä¿å¿«é€Ÿåé¦ˆä¸å¯ç»´æŠ¤æ€§ã€‚

**æµ‹è¯•é‡‘å­—å¡”ï¼š**

```mermaid
graph TD
    A[E2E Tests<br/>ç«¯åˆ°ç«¯æµ‹è¯•<br/>å°‘é‡]
    B[Integration Tests<br/>é›†æˆæµ‹è¯•<br/>ä¸­ç­‰]
    C[Unit Tests<br/>å•å…ƒæµ‹è¯•<br/>å¤§é‡]

    C --> B
    B --> A
```

**æµ‹è¯•ç­–ç•¥è¯´æ˜ï¼š**

-   **å•å…ƒæµ‹è¯•** - æµ‹è¯•å•ä¸ªå‡½æ•°ã€ç±»æˆ–ç»„ä»¶çš„é€»è¾‘
-   **é›†æˆæµ‹è¯•** - æµ‹è¯•å¤šä¸ªæ¨¡å—æˆ–ç»„ä»¶ä¹‹é—´çš„äº¤äº’
-   **ç«¯åˆ°ç«¯æµ‹è¯•** - æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·æµç¨‹

### æµ‹è¯•è¦†ç›–ç‡è¦æ±‚

ä¸ºç¡®ä¿ä»£ç è´¨é‡ï¼Œå¿…é¡»è¾¾åˆ°ä»¥ä¸‹æµ‹è¯•è¦†ç›–ç‡è¦æ±‚ï¼š

**è¦†ç›–ç‡æ ‡å‡†ï¼š**

-   **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æµ‹è¯•è¦†ç›–ç‡** - é¡»è¾¾åˆ° 80% ä»¥ä¸Š
-   **å…³é”®è·¯å¾„æµ‹è¯•è¦†ç›–ç‡** - é¡»è¾¾åˆ° 90% ä»¥ä¸Š
-   **æ‰€æœ‰å…¬å…± API** - å¿…é¡»å…·å¤‡æµ‹è¯•ç”¨ä¾‹

**è¦†ç›–ç‡ç»Ÿè®¡ï¼š**

-   **è¯­å¥è¦†ç›–ç‡ï¼ˆStatement Coverageï¼‰** - æ‰§è¡Œçš„ä»£ç è¡Œæ•°å æ€»è¡Œæ•°çš„æ¯”ä¾‹
-   **åˆ†æ”¯è¦†ç›–ç‡ï¼ˆBranch Coverageï¼‰** - æ‰§è¡Œçš„åˆ†æ”¯æ•°å æ€»åˆ†æ”¯æ•°çš„æ¯”ä¾‹
-   **å‡½æ•°è¦†ç›–ç‡ï¼ˆFunction Coverageï¼‰** - æ‰§è¡Œçš„å‡½æ•°æ•°å æ€»å‡½æ•°æ•°çš„æ¯”ä¾‹
-   **è¡Œè¦†ç›–ç‡ï¼ˆLine Coverageï¼‰** - æ‰§è¡Œçš„ä»£ç è¡Œæ•°å æ€»è¡Œæ•°çš„æ¯”ä¾‹

---

## å•å…ƒæµ‹è¯•

### æµ‹è¯•æ–‡ä»¶ä½ç½®

å•å…ƒæµ‹è¯•ä¸è¢«æµ‹æ–‡ä»¶åŒç›®å½•ï¼Œå‘½åæ ¼å¼ `{filename}.spec.ts`ã€‚

**ç¤ºä¾‹ï¼š**

```
libs/auth/src/lib/
â”œâ”€â”€ auth.service.ts
â”œâ”€â”€ auth.service.spec.ts
â”œâ”€â”€ auth.controller.ts
â”œâ”€â”€ auth.controller.spec.ts
â””â”€â”€ dto/
    â”œâ”€â”€ auth.dto.ts
    â””â”€â”€ auth.dto.spec.ts
```

### æµ‹è¯•æ¡†æ¶

ä½¿ç”¨ Jest ä½œä¸ºå•å…ƒæµ‹è¯•æ¡†æ¶ï¼Œé…åˆ NestJS çš„æµ‹è¯•å·¥å…·ã€‚

**Jest ç‰¹æ€§ï¼š**

-   **é›¶é…ç½®** - å¼€ç®±å³ç”¨çš„æµ‹è¯•æ¡†æ¶
-   **å¿«ç…§æµ‹è¯•** - è½»æ¾æ•è·å’Œæµ‹è¯• UI è¾“å‡º
-   **å¹¶è¡Œæ‰§è¡Œ** - åŠ å¿«æµ‹è¯•é€Ÿåº¦
-   **è¦†ç›–ç‡æŠ¥å‘Š** - å†…ç½®è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆ

**NestJS æµ‹è¯•å·¥å…·ï¼š**

-   **TestingModule** - åˆ›å»ºæµ‹è¯•æ¨¡å—
-   **Test.createTestingModule** - åˆ›å»ºæµ‹è¯•æ¨¡å—
-   **get** - è·å– Provider å®ä¾‹
-   **overrideProvider** - è¦†ç›– Provider

### æµ‹è¯•ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å•å…ƒæµ‹è¯•ç¤ºä¾‹ï¼š

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { AuthService } from './auth.service';
import { JwtUtils } from '@oksai/core';
import { getRepositoryToken } from '@mikro-orm/nestjs';
import { EntityRepository } from '@mikro-orm/core';
import { User, UserRole } from './entities/user.entity';

describe('AuthService', () => {
	let service: AuthService;
	let mockUserRepo: Partial<EntityRepository<User>>;
	let mockJwtUtils: Partial<JwtUtils>;

	beforeEach(async () => {
		// åˆ›å»º Mock Repository
		mockUserRepo = {
			findOne: jest.fn(),
			create: jest.fn(),
			persist: jest.fn(),
			flush: jest.fn()
		};

		// åˆ›å»º Mock JwtUtils
		mockJwtUtils = {
			generateTokenPair: jest.fn(),
			verifyAccessToken: jest.fn(),
			verifyRefreshToken: jest.fn()
		};

		const module: TestingModule = await Test.createTestingModule({
			providers: [
				AuthService,
				{
					provide: getRepositoryToken(User),
					useValue: mockUserRepo
				},
				{
					provide: JwtUtils,
					useValue: mockJwtUtils
				}
			]
		}).compile();

		service = module.get<AuthService>(AuthService);
	});

	afterEach(() => {
		jest.clearAllMocks();
	});

	it('should be defined', () => {
		expect(service).toBeDefined();
	});

	describe('login', () => {
		it('should login user with valid credentials', async () => {
			// Arrange
			const mockUser = {
				id: '123',
				email: 'user@example.com',
				password: 'hashedPassword',
				firstName: 'John',
				lastName: 'Doe',
				role: UserRole.USER,
				tenantId: '456'
			};

			const credentials = {
				email: 'user@example.com',
				password: 'password'
			};

			mockUserRepo.findOne.mockResolvedValue(mockUser);
			mockJwtUtils.generateTokenPair.mockReturnValue({
				accessToken: 'accessToken',
				refreshToken: 'refreshToken'
			});

			// Act
			const result = await service.login(credentials);

			// Assert
			expect(mockUserRepo.findOne).toHaveBeenCalledWith({
				email: credentials.email
			});
			expect(result).toHaveProperty('accessToken');
			expect(result).toHaveProperty('refreshToken');
			expect(result.user).toHaveProperty('id', '123');
		});

		it('should throw UnauthorizedException when user not found', async () => {
			// Arrange
			const credentials = {
				email: 'nonexistent@example.com',
				password: 'password'
			};

			mockUserRepo.findOne.mockResolvedValue(null);

			// Act & Assert
			await expect(service.login(credentials)).rejects.toThrow('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
		});

		it('should throw UnauthorizedException when password is invalid', async () => {
			// Arrange
			const mockUser = {
				id: '123',
				email: 'user@example.com',
				password: 'wrongPassword',
				firstName: 'John',
				lastName: 'Doe',
				role: UserRole.USER,
				tenantId: '456'
			};

			const credentials = {
				email: 'user@example.com',
				password: 'wrongPassword'
			};

			mockUserRepo.findOne.mockResolvedValue(mockUser);

			// Act & Assert
			await expect(service.login(credentials)).rejects.toThrow('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
		});
	});

	describe('register', () => {
		it('should register new user with valid data', async () => {
			// Arrange
			const credentials = {
				email: 'newuser@example.com',
				password: 'Password123!',
				firstName: 'Jane',
				lastName: 'Doe'
			};

			const mockUser = {
				id: '789',
				email: 'newuser@example.com',
				password: 'hashedPassword',
				firstName: 'Jane',
				lastName: 'Doe',
				role: UserRole.USER,
				tenantId: '456'
			};

			mockUserRepo.findOne.mockResolvedValue(null);
			mockUserRepo.create.mockReturnValue(mockUser);
			mockJwtUtils.generateTokenPair.mockReturnValue({
				accessToken: 'accessToken',
				refreshToken: 'refreshToken'
			});

			// Act
			const result = await service.register(credentials);

			// Assert
			expect(mockUserRepo.findOne).toHaveBeenCalledWith({
				email: credentials.email
			});
			expect(mockUserRepo.create).toHaveBeenCalled();
			expect(result).toHaveProperty('accessToken');
			expect(result.user).toHaveProperty('id', '789');
		});

		it('should throw ConflictException when email already exists', async () => {
			// Arrange
			const credentials = {
				email: 'existing@example.com',
				password: 'Password123!',
				firstName: 'Jane',
				lastName: 'Doe'
			};

			const existingUser = {
				id: '123',
				email: 'existing@example.com'
			};

			mockUserRepo.findOne.mockResolvedValue(existingUser);

			// Act & Assert
			await expect(service.register(credentials)).rejects.toThrow('æ­¤é‚®ç®±å·²è¢«æ³¨å†Œ');
		});
	});
});
```

### æµ‹è¯•æœ€ä½³å®è·µ

**å•å…ƒæµ‹è¯•æœ€ä½³å®è·µï¼š**

1. **AAA æ¨¡å¼** - Arrangeï¼ˆå‡†å¤‡ï¼‰ã€Actï¼ˆæ‰§è¡Œï¼‰ã€Assertï¼ˆæ–­è¨€ï¼‰
2. **ä¸€ä¸ªæµ‹è¯•ä¸€ä¸ªæ–­è¨€** - æ¯ä¸ªæµ‹è¯•åªéªŒè¯ä¸€ä¸ªè¡Œä¸º
3. **æè¿°æ€§æµ‹è¯•åç§°** - æµ‹è¯•åç§°åº”è¯¥æ¸…æ¥šåœ°æè¿°æµ‹è¯•å†…å®¹
4. **ä½¿ç”¨ Mock** - ä½¿ç”¨ Mock éš”ç¦»å¤–éƒ¨ä¾èµ–
5. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ** - æµ‹è¯•æ­£å¸¸æƒ…å†µå’Œå¼‚å¸¸æƒ…å†µ
6. **ä¿æŒæµ‹è¯•ç®€å•** - æµ‹è¯•åº”è¯¥ç®€å•ã€æ¸…æ™°ã€æ˜“äºç†è§£
7. **é¿å…æµ‹è¯•å®ç°ç»†èŠ‚** - æµ‹è¯•è¡Œä¸ºè€Œéå®ç°

**AAA æ¨¡å¼ç¤ºä¾‹ï¼š**

```typescript
it('should login user with valid credentials', async () => {
	// Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
	const mockUser = { id: '123', email: 'user@example.com' };
	const credentials = { email: 'user@example.com', password: 'password' };
	mockUserRepo.findOne.mockResolvedValue(mockUser);

	// Act - æ‰§è¡Œè¢«æµ‹è¯•çš„æ–¹æ³•
	const result = await service.login(credentials);

	// Assert - éªŒè¯ç»“æœ
	expect(result).toHaveProperty('accessToken');
});
```

---

## é›†æˆæµ‹è¯•

### æµ‹è¯•æ–‡ä»¶ä½ç½®

é›†æˆæµ‹è¯•æ”¾ç½®åœ¨ `tests/integration/` ç›®å½•ã€‚

**ç¤ºä¾‹ï¼š**

```
tests/
â””â”€â”€ integration/
    â”œâ”€â”€ auth/
    â”‚   â”œâ”€â”€ auth.controller.integration.spec.ts
    â”‚   â””â”€â”€ auth.service.integration.spec.ts
    â”œâ”€â”€ tenant/
    â”‚   â”œâ”€â”€ tenant.controller.integration.spec.ts
    â”‚   â””â”€â”€ tenant.service.integration.spec.ts
    â””â”€â”€ user/
        â”œâ”€â”€ user.controller.integration.spec.ts
        â””â”€â”€ user.service.integration.spec.ts
```

### æµ‹è¯•æ¡†æ¶

ä½¿ç”¨ Jest å’Œ Supertest è¿›è¡Œé›†æˆæµ‹è¯•ã€‚

**Supertest ç‰¹æ€§ï¼š**

-   **HTTP æ–­è¨€** - æä¾› HTTP æ–­è¨€æ–¹æ³•
-   **Express é›†æˆ** - ä¸ Express æ·±åº¦é›†æˆ
-   **é“¾å¼è°ƒç”¨** - æ”¯æŒé“¾å¼è°ƒç”¨ç¼–å†™æµ‹è¯•

### æµ‹è¯•ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„é›†æˆæµ‹è¯•ç¤ºä¾‹ï¼š

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '../../apps/base-api/src/app.module';
import { MikroOrmModule } from '@mikro-orm/nestjs';
import { User } from '@oksai/auth';
import { Tenant } from '@oksai/tenant';

describe('Auth Integration Tests', () => {
	let app: INestApplication;
	let authToken: string;

	beforeAll(async () => {
		const moduleFixture: TestingModule = await Test.createTestingModule({
			imports: [AppModule]
		}).compile();

		app = moduleFixture.createNestApplication();
		app.useGlobalPipes(new ValidationPipe());
		await app.init();
	});

	afterAll(async () => {
		await app.close();
	});

	describe('POST /api/v1/auth/register', () => {
		it('should register a new user', () => {
			return request(app.getHttpServer())
				.post('/api/v1/auth/register')
				.send({
					email: 'integration@example.com',
					password: 'Password123!',
					firstName: 'Integration',
					lastName: 'Test'
				})
				.expect(201)
				.expect((res) => {
					expect(res.body.success).toBe(true);
					expect(res.body.data).toHaveProperty('accessToken');
					expect(res.body.data).toHaveProperty('refreshToken');
					expect(res.body.data.user).toHaveProperty('email', 'integration@example.com');
				});
		});

		it('should throw error when email already exists', () => {
			return request(app.getHttpServer())
				.post('/api/v1/auth/register')
				.send({
					email: 'integration@example.com',
					password: 'Password123!',
					firstName: 'Integration',
					lastName: 'Test'
				})
				.expect(409)
				.expect((res) => {
					expect(res.body.success).toBe(false);
					expect(res.body.error.message).toContain('æ­¤é‚®ç®±å·²è¢«æ³¨å†Œ');
				});
		});
	});

	describe('POST /api/v1/auth/login', () => {
		it('should login with valid credentials', () => {
			return request(app.getHttpServer())
				.post('/api/v1/auth/login')
				.send({
					email: 'integration@example.com',
					password: 'Password123!'
				})
				.expect(200)
				.expect((res) => {
					expect(res.body.success).toBe(true);
					expect(res.body.data).toHaveProperty('accessToken');
					expect(res.body.data).toHaveProperty('refreshToken');
					authToken = res.body.data.accessToken;
				});
		});

		it('should throw error with invalid credentials', () => {
			return request(app.getHttpServer())
				.post('/api/v1/auth/login')
				.send({
					email: 'integration@example.com',
					password: 'wrongpassword'
				})
				.expect(401)
				.expect((res) => {
					expect(res.body.success).toBe(false);
					expect(res.body.error.message).toContain('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
				});
		});
	});

	describe('GET /api/v1/users/me', () => {
		it('should get current user', () => {
			return request(app.getHttpServer())
				.get('/api/v1/users/me')
				.set('Authorization', `Bearer ${authToken}`)
				.expect(200)
				.expect((res) => {
					expect(res.body.success).toBe(true);
					expect(res.body.data).toHaveProperty('email', 'integration@example.com');
				});
		});

		it('should throw error without token', () => {
			return request(app.getHttpServer()).get('/api/v1/users/me').expect(401);
		});
	});
});
```

### æµ‹è¯•æœ€ä½³å®è·µ

**é›†æˆæµ‹è¯•æœ€ä½³å®è·µï¼š**

1. **ä½¿ç”¨çœŸå®çš„ä¾èµ–** - æµ‹è¯•çœŸå®çš„æ•°æ®åº“å’Œå¤–éƒ¨æœåŠ¡
2. **ä½¿ç”¨æµ‹è¯•æ•°æ®åº“** - ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®åº“
3. **æ¸…ç†æµ‹è¯•æ•°æ®** - æ¯ä¸ªæµ‹è¯•åæ¸…ç†æ•°æ®
4. **æµ‹è¯•å®Œæ•´çš„æµç¨‹** - æµ‹è¯•å®Œæ•´çš„ä¸šåŠ¡æµç¨‹
5. **ä½¿ç”¨äº‹åŠ¡** - ä½¿ç”¨äº‹åŠ¡å›æ»šæµ‹è¯•æ•°æ®
6. **æµ‹è¯•é”™è¯¯æƒ…å†µ** - æµ‹è¯•æ­£å¸¸æƒ…å†µå’Œé”™è¯¯æƒ…å†µ

---

## ç«¯åˆ°ç«¯æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶ä½ç½®

ç«¯åˆ°ç«¯æµ‹è¯•æ”¾ç½®åœ¨ `apps/base-api/src/e2e/` ç›®å½•ã€‚

**ç¤ºä¾‹ï¼š**

```
apps/base-api/src/e2e/
â”œâ”€â”€ app.e2e-spec.ts
â”œâ”€â”€ auth.e2e-spec.ts
â”œâ”€â”€ tenant.e2e-spec.ts
â””â”€â”€ user.e2e-spec.ts
```

### æµ‹è¯•æ¡†æ¶

ä½¿ç”¨ Jest å’Œ Supertest è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ã€‚

**ç«¯åˆ°ç«¯æµ‹è¯•é…ç½®ï¼š**

```typescript
export default {
	preset: 'ts-jest',
	testEnvironment: 'node',
	roots: ['<rootDir>/e2e'],
	testMatch: ['**/*.e2e-spec.ts'],
	moduleNameMapper: {
		'^@/(.*)$': '<rootDir>/../src/$1',
		'^@oksai/(.*)$': '<rootDir>/../../libs/$1/src'
	}
};
```

### æµ‹è¯•ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•ç¤ºä¾‹ï¼š

```typescript
import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import * as request from 'supertest';
import { AppModule } from '../src/app.module';
import { MikroOrmModule } from '@mikro-orm/nestjs';

describe('App E2E Tests', () => {
	let app: INestApplication;
	let authToken: string;
	let userId: string;

	beforeAll(async () => {
		const moduleFixture: TestingModule = await Test.createTestingModule({
			imports: [AppModule]
		}).compile();

		app = moduleFixture.createNestApplication();
		app.useGlobalPipes(new ValidationPipe());
		await app.init();
	});

	afterAll(async () => {
		await app.close();
	});

	describe('å®Œæ•´ç”¨æˆ·æ³¨å†Œå’Œç™»å½•æµç¨‹', () => {
		it('åº”è¯¥å®Œæˆæ³¨å†Œã€ç™»å½•å’Œè·å–ç”¨æˆ·ä¿¡æ¯çš„å®Œæ•´æµç¨‹', async () => {
			// æ­¥éª¤ 1ï¼šæ³¨å†Œç”¨æˆ·
			const registerResponse = await request(app.getHttpServer())
				.post('/api/v1/auth/register')
				.send({
					email: 'e2e@example.com',
					password: 'Password123!',
					firstName: 'E2E',
					lastName: 'Test'
				})
				.expect(201);

			expect(registerResponse.body.success).toBe(true);
			expect(registerResponse.body.data.user).toHaveProperty('id');
			userId = registerResponse.body.data.user.id;

			// æ­¥éª¤ 2ï¼šç™»å½•
			const loginResponse = await request(app.getHttpServer())
				.post('/api/v1/auth/login')
				.send({
					email: 'e2e@example.com',
					password: 'Password123!'
				})
				.expect(200);

			expect(loginResponse.body.success).toBe(true);
			expect(loginResponse.body.data).toHaveProperty('accessToken');
			authToken = loginResponse.body.data.accessToken;

			// æ­¥éª¤ 3ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
			const userResponse = await request(app.getHttpServer())
				.get('/api/v1/users/me')
				.set('Authorization', `Bearer ${authToken}`)
				.expect(200);

			expect(userResponse.body.success).toBe(true);
			expect(userResponse.body.data).toHaveProperty('id', userId);
			expect(userResponse.body.data).toHaveProperty('email', 'e2e@example.com');
		});
	});

	describe('æƒé™éªŒè¯', () => {
		it('åº”è¯¥æ‹’ç»æœªæˆæƒçš„è®¿é—®', async () => {
			await request(app.getHttpServer()).get('/api/v1/users').expect(401);
		});

		it('åº”è¯¥æ‹’ç»æ²¡æœ‰æƒé™çš„è®¿é—®', async () => {
			// ä½¿ç”¨æ™®é€šç”¨æˆ·ä»¤ç‰Œè®¿é—®ç®¡ç†å‘˜æ¥å£
			await request(app.getHttpServer())
				.get('/api/v1/admin/users')
				.set('Authorization', `Bearer ${authToken}`)
				.expect(403);
		});
	});

	describe('é”™è¯¯å¤„ç†', () => {
		it('åº”è¯¥æ­£ç¡®å¤„ç† 404 é”™è¯¯', async () => {
			await request(app.getHttpServer())
				.get('/api/v1/users/nonexistent-id')
				.set('Authorization', `Bearer ${authToken}`)
				.expect(404)
				.expect((res) => {
					expect(res.body.success).toBe(false);
					expect(res.body.error.message).toContain('æœªæ‰¾åˆ°');
				});
		});

		it('åº”è¯¥æ­£ç¡®å¤„ç† 400 é”™è¯¯', async () => {
			await request(app.getHttpServer())
				.post('/api/v1/auth/register')
				.send({
					email: 'invalid-email',
					password: 'short',
					firstName: 'Test',
					lastName: 'User'
				})
				.expect(400);
		});
	});
});
```

### æµ‹è¯•æœ€ä½³å®è·µ

**ç«¯åˆ°ç«¯æµ‹è¯•æœ€ä½³å®è·µï¼š**

1. **æµ‹è¯•å…³é”®æµç¨‹** - æµ‹è¯•æœ€é‡è¦çš„ç”¨æˆ·æµç¨‹
2. **ä½¿ç”¨çœŸå®ç¯å¢ƒ** - ä½¿ç”¨ä¸ç”Ÿäº§ç¯å¢ƒç›¸ä¼¼çš„é…ç½®
3. **æµ‹è¯•è·¨é¡µé¢** - æµ‹è¯•è·¨å¤šä¸ªé¡µé¢çš„ç”¨æˆ·æµç¨‹
4. **ä½¿ç”¨ Page Object Model** - ä½¿ç”¨é¡µé¢å¯¹è±¡æ¨¡å¼
5. **æ¸…ç†æµ‹è¯•æ•°æ®** - æ¯ä¸ªæµ‹è¯•åæ¸…ç†æ•°æ®
6. **ä½¿ç”¨ç­‰å¾…æœºåˆ¶** - ä½¿ç”¨é€‚å½“çš„ç­‰å¾…æœºåˆ¶

---

## æµ‹è¯•å‘½ä»¤

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼š

```bash
pnpm test
```

### è¿è¡ŒæŒ‡å®šåŒ…çš„æµ‹è¯•

è¿è¡ŒæŒ‡å®šåŒ…çš„æµ‹è¯•ï¼š

```bash
cd libs/<package-name> && pnpm test
```

**ç¤ºä¾‹ï¼š**

```bash
cd libs/auth && pnpm test
```

### è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶

è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶ï¼š

```bash
cd libs/<package-name> && pnpm test <filename>.spec.ts
```

**ç¤ºä¾‹ï¼š**

```bash
cd libs/auth && pnpm test auth.service.spec.ts
```

### ç›‘å¬æ¨¡å¼è¿è¡Œæµ‹è¯•

ä»¥ç›‘å¬æ¨¡å¼è¿è¡Œæµ‹è¯•ï¼Œæµ‹è¯•æ–‡ä»¶å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°è¿è¡Œï¼š

```bash
cd libs/<package-name> && pnpm run test:watch
```

### ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š

è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼š

```bash
cd libs/<package-name> && pnpm run test:cov
```

**è¦†ç›–ç‡æŠ¥å‘Šç¤ºä¾‹ï¼š**

```
----------|---------|----------|---------|---------|-------------------
File        | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
----------|---------|----------|---------|---------|-------------------
All files   |   85.32 |    75.45 |   91.23 |   84.56 |
 auth.service.ts |   90.45 |    80.23 |   95.12 |   89.34 | 45,67,89
 auth.controller.ts |   82.34 |    72.45 |   88.56 |   81.23 | 12,34,56,78
----------|---------|----------|---------|---------|-------------------
```

---

## æµ‹è¯•å·¥å…·

### Jest

Jest æ˜¯ä¸€ä¸ªæµè¡Œçš„ JavaScript æµ‹è¯•æ¡†æ¶ï¼Œæä¾›å®Œæ•´çš„æµ‹è¯•è§£å†³æ–¹æ¡ˆã€‚

**Jest é…ç½®ï¼š**

```javascript
module.exports = {
	preset: 'ts-jest',
	testEnvironment: 'node',
	roots: ['<rootDir>/src', '<rootDir>/libs'],
	testMatch: ['**/*.spec.ts'],
	moduleNameMapper: {
		'^@oksai/(.*)$': '<rootDir>/../../libs/$1/src',
		'^@/(.*)$': '<rootDir>/src/$1'
	},
	collectCoverageFrom: ['**/*.ts', '!**/*.spec.ts', '!**/*.dto.ts', '!**/*.interface.ts', '!**/node_modules/**']
};
```

**å¸¸ç”¨ Jest APIï¼š**

-   `describe` - æµ‹è¯•å¥—ä»¶
-   `it` / `test` - æµ‹è¯•ç”¨ä¾‹
-   `beforeAll` - æ‰€æœ‰æµ‹è¯•ä¹‹å‰æ‰§è¡Œ
-   `afterAll` - æ‰€æœ‰æµ‹è¯•ä¹‹åæ‰§è¡Œ
-   `beforeEach` - æ¯ä¸ªæµ‹è¯•ä¹‹å‰æ‰§è¡Œ
-   `afterEach` - æ¯ä¸ªæµ‹è¯•ä¹‹åæ‰§è¡Œ
-   `expect` - æ–­è¨€
-   `jest.fn()` - åˆ›å»º Mock å‡½æ•°
-   `jest.mock()` - Mock æ¨¡å—

### Supertest

Supertest æ˜¯ä¸€ä¸ª HTTP æµ‹è¯•åº“ï¼Œç”¨äºæµ‹è¯• Node.js HTTP æœåŠ¡å™¨ã€‚

**Supertest ç‰¹æ€§ï¼š**

-   **HTTP æ–­è¨€** - æä¾› HTTP æ–­è¨€æ–¹æ³•
-   **Express é›†æˆ** - ä¸ Express æ·±åº¦é›†æˆ
-   **é“¾å¼è°ƒç”¨** - æ”¯æŒé“¾å¼è°ƒç”¨ç¼–å†™æµ‹è¯•

**Supertest ç¤ºä¾‹ï¼š**

```typescript
import * as request from 'supertest';

describe('Auth API', () => {
	it('should register a new user', async () => {
		await request(app.getHttpServer())
			.post('/api/v1/auth/register')
			.send({
				email: 'test@example.com',
				password: 'Password123!',
				firstName: 'Test',
				lastName: 'User'
			})
			.expect(201)
			.expect((res) => {
				expect(res.body.success).toBe(true);
			});
	});
});
```

### æµ‹è¯•æ›¿èº«

ä½¿ç”¨æµ‹è¯•æ›¿èº«ï¼ˆTest Doublesï¼‰éš”ç¦»å¤–éƒ¨ä¾èµ–ã€‚

**æµ‹è¯•æ›¿èº«ç±»å‹ï¼š**

-   **Stub** - æä¾›é¢„å®šä¹‰çš„å“åº”
-   **Mock** - è®°å½•å’ŒéªŒè¯è°ƒç”¨
-   **Spy** - ç›‘å¬å‡½æ•°è°ƒç”¨
-   **Fake** - ç®€å•çš„å®ç°

**Stub ç¤ºä¾‹ï¼š**

```typescript
const mockUserRepo = {
	findOne: jest.fn().mockResolvedValue(mockUser)
};
```

**Mock ç¤ºä¾‹ï¼š**

```typescript
const mockLogger = {
	log: jest.fn(),
	error: jest.fn()
};

expect(mockLogger.log).toHaveBeenCalledWith('æµ‹è¯•æ—¥å¿—');
expect(mockLogger.log).toHaveBeenCalledTimes(1);
```

---

## æµ‹è¯• CI/CD

### æŒç»­é›†æˆ

åœ¨ CI/CD æµæ°´çº¿ä¸­è‡ªåŠ¨è¿è¡Œæµ‹è¯•ã€‚

**GitHub Actions é…ç½®ç¤ºä¾‹ï¼š**

```yaml
name: Test

on: [push, pull_request]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v3
              with:
                  node-version: '20'
            - run: pnpm install
            - run: pnpm test
            - run: pnpm run test:cov
            - uses: codecov/codecov-action@v3
              with:
                  files: ./coverage/lcov.info
```

### æµ‹è¯•æŠ¥å‘Š

ç”Ÿæˆå¹¶ä¸Šä¼ æµ‹è¯•æŠ¥å‘Šã€‚

**æµ‹è¯•æŠ¥å‘Šå·¥å…·ï¼š**

-   **Jest Coverage** - å†…ç½®è¦†ç›–ç‡æŠ¥å‘Š
-   **Codecov** - è¦†ç›–ç‡æŠ¥å‘Šä¸Šä¼ 
-   **SonarQube** - ä»£ç è´¨é‡åˆ†æ

**Codecov é…ç½®ï¼š**

```yaml
coverage:
    precision: 2
    round: down
    range: '70...100'
    status:
        project:
            default:
                target: 80
                threshold: 1%
```

### æµ‹è¯•å¤±è´¥å¤„ç†

å¤„ç†æµ‹è¯•å¤±è´¥çš„æƒ…å†µã€‚

**æµ‹è¯•å¤±è´¥å¤„ç†ç­–ç•¥ï¼š**

1. **å¿«é€Ÿåé¦ˆ** - å°½å¿«å‘ç°æµ‹è¯•å¤±è´¥
2. **å¤±è´¥åŸå› åˆ†æ** - åˆ†ææµ‹è¯•å¤±è´¥çš„åŸå› 
3. **ä¿®å¤ä¼˜å…ˆçº§** - ä¼˜å…ˆä¿®å¤æ ¸å¿ƒä¸šåŠ¡æµ‹è¯•
4. **å¤±è´¥é€šçŸ¥** - åŠæ—¶é€šçŸ¥ç›¸å…³äººå‘˜

**GitHub Actions æµ‹è¯•å¤±è´¥é€šçŸ¥ï¼š**

```yaml
- name: Notify on failure
  if: failure()
  uses: actions/github-script@v6
  with:
      script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'æµ‹è¯•å¤±è´¥',
            body: 'æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—'
          });
```

---

## å¸¸è§é—®é¢˜

### æµ‹è¯•ç›¸å…³

**Q: å¦‚ä½•è¿è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Ÿ**

A: ä½¿ç”¨ `.only()` ä¿®é¥°ç¬¦è¿è¡Œå•ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

```typescript
describe('AuthService', () => {
	it.only('should login user with valid credentials', async () => {
		// è¿™ä¸ªæµ‹è¯•ä¼šå•ç‹¬è¿è¡Œ
	});
});
```

**Q: å¦‚ä½•è·³è¿‡æŸä¸ªæµ‹è¯•ï¼Ÿ**

A: ä½¿ç”¨ `.skip()` ä¿®é¥°ç¬¦è·³è¿‡æŸä¸ªæµ‹è¯•ï¼š

```typescript
describe('AuthService', () => {
	it.skip('should login user with valid credentials', async () => {
		// è¿™ä¸ªæµ‹è¯•ä¼šè¢«è·³è¿‡
	});
});
```

**Q: å¦‚ä½•æµ‹è¯•å¼‚æ­¥ä»£ç ï¼Ÿ**

A: ä½¿ç”¨ `async/await` å¤„ç†å¼‚æ­¥ä»£ç ï¼š

```typescript
it('should login user with valid credentials', async () => {
	const result = await service.login(credentials);
	expect(result).toHaveProperty('accessToken');
});
```

### è¦†ç›–ç‡ç›¸å…³

**Q: å¦‚ä½•æé«˜æµ‹è¯•è¦†ç›–ç‡ï¼Ÿ**

A: ä»¥ä¸‹æ˜¯ä¸€äº›æé«˜æµ‹è¯•è¦†ç›–ç‡çš„æ–¹æ³•ï¼š

1. **æ·»åŠ æ›´å¤šçš„æµ‹è¯•ç”¨ä¾‹** - è¦†ç›–æ›´å¤šçš„ä»£ç è·¯å¾„
2. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ** - æµ‹è¯•æ­£å¸¸æƒ…å†µå’Œå¼‚å¸¸æƒ…å†µ
3. **ä½¿ç”¨è¦†ç›–ç‡æŠ¥å‘Š** - è¯†åˆ«æœªè¦†ç›–çš„ä»£ç 
4. **é‡æ„ä»£ç ** - ç®€åŒ–å¤æ‚çš„ä»£ç é€»è¾‘

**Q: è¦†ç›–ç‡æŠ¥å‘Šæ˜¾ç¤ºæŸä¸ªæ–‡ä»¶æ²¡æœ‰è¦†ç›–ï¼Ÿ**

A: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. **æµ‹è¯•æ–‡ä»¶ä½ç½®** - ç¡®ä¿æµ‹è¯•æ–‡ä»¶ä½ç½®æ­£ç¡®
2. **æµ‹è¯•æ–‡ä»¶å‘½å** - ç¡®ä¿æµ‹è¯•æ–‡ä»¶å‘½åæ­£ç¡®ï¼ˆ`.spec.ts`ï¼‰
3. **è¦†ç›–ç‡é…ç½®** - ç¡®ä¿è¦†ç›–ç‡é…ç½®æ­£ç¡®

### CI/CD ç›¸å…³

**Q: å¦‚ä½•åœ¨ CI/CD ä¸­è¿è¡Œæµ‹è¯•ï¼Ÿ**

A: åœ¨ CI/CD é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æµ‹è¯•æ­¥éª¤ï¼š

```yaml
steps:
    - run: pnpm install
    - run: pnpm test
    - run: pnpm run test:cov
```

**Q: å¦‚ä½•åœ¨ CI/CD ä¸­å¤„ç†æµ‹è¯•å¤±è´¥ï¼Ÿ**

A: åœ¨ CI/CD é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¤±è´¥å¤„ç†ï¼š

```yaml
steps:
    - run: pnpm test || echo "æµ‹è¯•å¤±è´¥"
```

---

## ç‰ˆæœ¬ä¿¡æ¯

-   **æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0.0
-   **æœ€åæ›´æ–°ï¼š** 2026-02-04
-   **ç»´æŠ¤è€…ï¼š** OKSAI å¹³å°å›¢é˜Ÿ
