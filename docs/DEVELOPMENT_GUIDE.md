# å¼€å‘æŒ‡å—

## ğŸ“‘ ç›®å½•

-   [ç¯å¢ƒæ­å»º](#ç¯å¢ƒæ­å»º)
    -   [å‰ç½®è¦æ±‚](#å‰ç½®è¦æ±‚)
    -   [å®‰è£…æ­¥éª¤](#å®‰è£…æ­¥éª¤)
-   [é¡¹ç›®ç»“æ„è¯¦è§£](#é¡¹ç›®ç»“æ„è¯¦è§£)
-   [å¼€å‘å·¥ä½œæµç¨‹](#å¼€å‘å·¥ä½œæµç¨‹)
-   [å¸¸ç”¨å¼€å‘å‘½ä»¤](#å¸¸ç”¨å¼€å‘å‘½ä»¤)
    -   [å¯åŠ¨å¼€å‘æœåŠ¡](#å¯åŠ¨å¼€å‘æœåŠ¡)
    -   [æ„å»ºå‘½ä»¤](#æ„å»ºå‘½ä»¤)
    -   [æµ‹è¯•å‘½ä»¤](#æµ‹è¯•å‘½ä»¤)
    -   [ä»£ç æ£€æŸ¥å‘½ä»¤](#ä»£ç æ£€æŸ¥å‘½ä»¤)
    -   [æ•°æ®åº“è¿ç§»å‘½ä»¤](#æ•°æ®åº“è¿ç§»å‘½ä»¤)
-   [åˆ›å»ºæ–°æ¨¡å—æŒ‡å—](#åˆ›å»ºæ–°æ¨¡å—æŒ‡å—)
    -   [åˆ›å»ºæ¨¡å—ç›®å½•](#åˆ›å»ºæ¨¡å—ç›®å½•)
    -   [åˆ›å»ºå®ä½“](#åˆ›å»ºå®ä½“)
    -   [åˆ›å»º DTO](#åˆ›å»º-dto)
    -   [åˆ›å»º Service](#åˆ›å»º-service)
    -   [åˆ›å»º Controller](#åˆ›å»º-controller)
    -   [åˆ›å»º Module](#åˆ›å»º-module)
    -   [åˆ›å»º Plugin](#åˆ›å»º-plugin)
    -   [åœ¨ AppModule ä¸­æ³¨å†Œ](#åœ¨-appmodule-ä¸­æ³¨å†Œ)
-   [ä» backup å¤ç”¨ä»£ç æŒ‡å—](#ä»-backup-å¤ç”¨ä»£ç æŒ‡å—)
    -   [å¦‚ä½•æŸ¥æ‰¾å‚è€ƒä»£ç ](#å¦‚ä½•æŸ¥æ‰¾å‚è€ƒä»£ç )
    -   [å¦‚ä½•ç®€åŒ–æ—§ä»£ç ](#å¦‚ä½•ç®€åŒ–æ—§ä»£ç )
    -   [æ³¨æ„äº‹é¡¹](#æ³¨æ„äº‹é¡¹)
-   [å¼€å‘é…ç½®](#å¼€å‘é…ç½®)
    -   [æ•°æ®åº“é…ç½®](#æ•°æ®åº“é…ç½®)
    -   [JWT é…ç½®](#jwt-é…ç½®)
    -   [OAuth é…ç½®](#oauth-é…ç½®)
    -   [é‚®ä»¶é…ç½®](#é‚®ä»¶é…ç½®)
    -   [Redis é…ç½®](#redis-é…ç½®)
-   [è°ƒè¯•æŠ€å·§](#è°ƒè¯•æŠ€å·§)
    -   [VS Code è°ƒè¯•é…ç½®](#vs-code-è°ƒè¯•é…ç½®)
    -   [æ—¥å¿—è¾“å‡ºè§„èŒƒ](#æ—¥å¿—è¾“å‡ºè§„èŒƒ)
    -   [å¸¸è§é”™è¯¯æ’æŸ¥](#å¸¸è§é”™è¯¯æ’æŸ¥)
-   [Git å·¥ä½œæµ](#git-å·¥ä½œæµ)
    -   [åˆ†æ”¯ç­–ç•¥](#åˆ†æ”¯ç­–ç•¥)
    -   [æäº¤ä¿¡æ¯è§„èŒƒ](#æäº¤ä¿¡æ¯è§„èŒƒ)
    -   [ä»£ç å®¡æŸ¥æµç¨‹](#ä»£ç å®¡æŸ¥æµç¨‹)
-   [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)
    -   [å¼€å‘ç¯å¢ƒç›¸å…³](#å¼€å‘ç¯å¢ƒç›¸å…³)
    -   [æ„å»ºå’Œéƒ¨ç½²ç›¸å…³](#æ„å»ºå’Œéƒ¨ç½²ç›¸å…³)
    -   [æ•°æ®åº“ç›¸å…³](#æ•°æ®åº“ç›¸å…³)

---

## ç¯å¢ƒæ­å»º

### å‰ç½®è¦æ±‚

åœ¨å¼€å§‹å¼€å‘ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨çš„å¼€å‘ç¯å¢ƒæ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

-   **Node.js** 20.x æˆ–æ›´é«˜ç‰ˆæœ¬
-   **pnpm** 10.11.0 æˆ–æ›´é«˜ç‰ˆæœ¬
-   **PostgreSQL** 12.x æˆ–æ›´é«˜ç‰ˆæœ¬
-   **Redis**ï¼ˆå¯é€‰ï¼Œç”¨äºé‚®ä»¶é˜Ÿåˆ—ï¼‰
-   **Git**

### å®‰è£…æ­¥éª¤

#### 1. å…‹éš†é¡¹ç›®ä»“åº“

```bash
git clone https://github.com/oksais/platform.git
cd oksai-api-server
```

#### 2. å®‰è£…ä¾èµ–

```bash
pnpm install
```

#### 3. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ `.env.example` æ–‡ä»¶ä¸º `.env`ï¼Œå¹¶æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹é…ç½®ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å…³é”®å‚æ•°ï¼š

```bash
# åº”ç”¨é…ç½®
NODE_ENV=development
PORT=3000

# æ•°æ®åº“é…ç½®
DB_TYPE=postgres
DB_HOST=localhost
DB_PORT=5432
DB_NAME=oksai_platform
DB_USER=postgres
DB_PASSWORD=your_password

# JWT é…ç½®
JWT_SECRET=your_jwt_secret
JWT_REFRESH_SECRET=your_refresh_secret
JWT_EXPIRES_IN=1d
JWT_REFRESH_EXPIRES_IN=7d

# OAuth é…ç½®ï¼ˆå¯é€‰ï¼‰
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
```

#### 4. åˆå§‹åŒ–æ•°æ®åº“

```bash
# åˆ›å»ºæ•°æ®åº“è¿ç§»
pnpm migration:generate --name=init

# è¿è¡Œæ•°æ®åº“è¿ç§»
pnpm migration:run
```

#### 5. å¯åŠ¨å¼€å‘æœåŠ¡

```bash
cd apps/base-api && pnpm run start:dev
```

æœåŠ¡å¯åŠ¨åï¼Œè®¿é—® `http://localhost:3000/api/v1/health` æ£€æŸ¥æœåŠ¡çŠ¶æ€ã€‚

---

## é¡¹ç›®ç»“æ„è¯¦è§£

```mermaid
graph TB
    Root[oksai-api-server]
    Root --> Apps[apps/]
    Root --> Libs[libs/]
    Root --> Backup[backup/]
    Root --> Docs[docs/]
    Root --> Tools[tools/]

    Apps --> BaseAPI[base-api/]
    BaseAPI --> Src[src/]
    Src --> AppModule[app.module.ts]
    Src --> Main[main.ts]
    Src --> Config[config/]
    Src --> Shared[shared/]

    Libs --> Auth[auth/]
    Libs --> Core[core/]
    Libs --> Tenant[tenant/]
    Libs --> User[user/]
    Libs --> Org[organization/]
    Libs --> Role[role/]
    Libs --> Audit[audit/]
    Libs --> Plugin[plugin/]
    Libs --> Common[common/]
    Libs --> Config[config/]
    Libs --> Constants[constants/]
    Libs --> Contracts[contracts/]
    Libs --> Utils[utils/]

    Backup --> BackupAuth[auth/]
    Backup --> BackupCore[core/]
    Backup --> BackupPlugins[plugins/]
```

**ç›®å½•è¯´æ˜ï¼š**

-   **apps/** - åº”ç”¨å±‚ï¼ŒåŒ…å«æ‰€æœ‰åº”ç”¨ä»£ç 
    -   **base-api/** - ä¸» NestJS åº”ç”¨
    -   **mcp/** - MCP æœåŠ¡å™¨
    -   **mcp-auth/** - MCP è®¤è¯æœåŠ¡
-   **libs/** - æ–°å¼€å‘çš„ @oksai/\* åŒ…
    -   **auth/** - è®¤è¯æ¨¡å—
    -   **core/** - æ ¸å¿ƒæ¨¡å—
    -   **tenant/** - ç§Ÿæˆ·æ¨¡å—
    -   **user/** - ç”¨æˆ·æ¨¡å—
    -   **organization/** - ç»„ç»‡æ¨¡å—
    -   **role/** - è§’è‰²æƒé™
    -   **audit/** - å®¡è®¡æ—¥å¿—
    -   **plugin/** - æ’ä»¶ç³»ç»Ÿ
    -   **common/** - å…¬å…±æ¨¡å—
    -   **config/** - é…ç½®æ¨¡å—
    -   **constants/** - å¸¸é‡å®šä¹‰
    -   **contracts/** - å¥‘çº¦/æ¥å£å®šä¹‰
    -   **utils/** - å·¥å…·å‡½æ•°
-   **backup/** - æ—§é¡¹ç›®ä»£ç ï¼ˆå‚è€ƒï¼Œä¸ä¿®æ”¹ï¼‰
-   **docs/** - é¡¹ç›®æ–‡æ¡£
-   **tools/** - å·¥å…·è„šæœ¬

---

## å¼€å‘å·¥ä½œæµç¨‹

```mermaid
graph TD
    A[å¼€å§‹å¼€å‘] --> B[ä» backup/ æŸ¥è€ƒæ—§ä»£ç ]
    B --> C[åœ¨ libs/ åˆ›å»ºæ–°æ¨¡å—]
    C --> D[éµå¾ªä»£ç è§„èŒƒç¼–å†™ä»£ç ]
    D --> E[ç¼–å†™ TSDoc æ³¨é‡Š]
    E --> F[ç¼–å†™å•å…ƒæµ‹è¯•]
    F --> G[è¿è¡Œæµ‹è¯•å’Œç±»å‹æ£€æŸ¥]
    G --> H{æµ‹è¯•é€šè¿‡?}
    H -->|æ˜¯| I[æäº¤ä»£ç ]
    H -->|å¦| D
    I --> J[ä»£ç å®¡æŸ¥]
    J --> K{å®¡æŸ¥é€šè¿‡?}
    K -->|æ˜¯| L[åˆå¹¶ä»£ç ]
    K -->|å¦| D
```

**è¯¦ç»†è¯´æ˜ï¼š**

1. **ä» backup/ æŸ¥è€ƒæ—§ä»£ç ** - åœ¨ `backup/` ç›®å½•ä¸­æŸ¥æ‰¾ç›¸å…³åŠŸèƒ½çš„å‚è€ƒä»£ç 
2. **åœ¨ libs/ åˆ›å»ºæ–°æ¨¡å—** - åœ¨ `libs/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ @oksai/\* åŒ…
3. **éµå¾ªä»£ç è§„èŒƒç¼–å†™ä»£ç ** - æŒ‰ç…§ [ä»£ç è§„èŒƒ](./CODING_STANDARDS.md) ç¼–å†™ä»£ç 
4. **ç¼–å†™ TSDoc æ³¨é‡Š** - ä¸ºå…¬å…± API æ·»åŠ å®Œæ•´çš„ TSDoc æ³¨é‡Š
5. **ç¼–å†™å•å…ƒæµ‹è¯•** - ç¼–å†™å•å…ƒæµ‹è¯•ï¼ˆè¦†ç›–ç‡ â‰¥ 80%ï¼‰
6. **è¿è¡Œæµ‹è¯•å’Œç±»å‹æ£€æŸ¥** - è¿è¡Œæµ‹è¯•å’Œç±»å‹æ£€æŸ¥ï¼Œç¡®ä¿ä»£ç è´¨é‡
7. **æäº¤ä»£ç ** - æäº¤ä»£ç ï¼ˆGit æäº¤ä¿¡æ¯ä½¿ç”¨è‹±æ–‡ï¼‰
8. **ä»£ç å®¡æŸ¥** - ä»£ç å®¡æŸ¥
9. **åˆå¹¶ä»£ç ** - åˆå¹¶ä»£ç 

---

## å¸¸ç”¨å¼€å‘å‘½ä»¤

### å¯åŠ¨å¼€å‘æœåŠ¡

```bash
# å¯åŠ¨ base-api åº”ç”¨ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
cd apps/base-api && pnpm run start:dev

# å¯åŠ¨ base-api åº”ç”¨ï¼ˆç”Ÿäº§æ¨¡å¼ï¼‰
cd apps/base-api && pnpm run build && pnpm run start

# ä½¿ç”¨ Turbo å¯åŠ¨æ‰€æœ‰åº”ç”¨
pnpm dev
```

### æ„å»ºå‘½ä»¤

```bash
# æ„å»ºæŒ‡å®šçš„ @oksai åŒ…
pnpm run build --filter="@oksai/<package-name>"

# æ„å»ºæ‰€æœ‰ @oksai åŒ…
pnpm run build --filter="@oksai/**"

# æ„å»ºæ‰€æœ‰åŒ…
pnpm run build

# ä» libs/ ç›®å½•æ„å»ºå•ä¸ªåŒ…
cd libs/<package-name> && pnpm run build
```

### æµ‹è¯•å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡ŒæŒ‡å®šåŒ…çš„æµ‹è¯•
cd libs/<package-name> && pnpm test

# è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
cd libs/<package-name> && pnpm test user.service.spec.ts

# ä»¥ç›‘å¬æ¨¡å¼è¿è¡Œæµ‹è¯•
cd libs/<package-name> && pnpm run test:watch

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
cd libs/<package-name> && pnpm run test:cov
```

### ä»£ç æ£€æŸ¥å‘½ä»¤

```bash
# æ£€æŸ¥æ‰€æœ‰åŒ…
pnpm run lint

# æ£€æŸ¥æŒ‡å®šåŒ…
cd libs/<package-name> && pnpm run lint

# ç±»å‹æ£€æŸ¥ï¼ˆæ‰€æœ‰åŒ…ï¼‰
pnpm run typecheck

# ç±»å‹æ£€æŸ¥ï¼ˆæŒ‡å®šåŒ…ï¼‰
cd libs/<package-name> && pnpm run typecheck
```

### æ•°æ®åº“è¿ç§»å‘½ä»¤

```bash
# åˆ›å»ºæ–°çš„è¿ç§»
pnpm migration:create

# ç”Ÿæˆè¿ç§»ï¼ˆåŸºäºå®ä½“å˜æ›´ï¼‰
pnpm migration:generate

# è¿è¡Œè¿ç§»
pnpm migration:run

# å›æ»šè¿ç§»
pnpm migration:revert
```

---

## åˆ›å»ºæ–°æ¨¡å—æŒ‡å—

### åˆ›å»ºæ¨¡å—ç›®å½•

åœ¨ `libs/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„æ¨¡å—ç›®å½•ï¼š

```bash
mkdir -p libs/<module-name>/src/lib/entities
mkdir -p libs/<module-name>/src/lib/dto
```

### åˆ›å»ºå®ä½“

åˆ›å»º `libs/<module-name>/src/lib/entities/<entity-name>.entity.ts`ï¼š

```typescript
import { Entity, Property, Enum, Index } from '@mikro-orm/core';
import { BaseEntity } from '@oksai/core';

/**
 * çŠ¶æ€æšä¸¾
 */
export enum EntityStatus {
	/** æ´»è·ƒçŠ¶æ€ */
	ACTIVE = 'ACTIVE',
	/** æš‚åœçŠ¶æ€ */
	SUSPENDED = 'SUSPENDED'
}

/**
 * å®ä½“åç§°
 *
 * å®ä½“æè¿°ä¿¡æ¯
 */
@Entity({ tableName: '<table_name>' })
@Index({ name: 'idx_entity_tenant', properties: ['tenantId'] })
@Index({ name: 'idx_entity_status', properties: ['status'] })
export class EntityName extends BaseEntity {
	/** å®ä½“åç§° */
	@Property()
	name!: string;

	/** å®ä½“çŠ¶æ€ï¼ˆé»˜è®¤ï¼šACTIVEï¼‰ */
	@Property({ default: EntityStatus.ACTIVE })
	@Enum(() => EntityStatus)
	status: EntityStatus = EntityStatus.ACTIVE;

	/** æ‰€å±ç§Ÿæˆ· ID */
	@Property()
	tenantId!: string;
}
```

### åˆ›å»º DTO

åˆ›å»º `libs/<module-name>/src/lib/dto/<entity-name>.dto.ts`ï¼š

```typescript
/**
 * åˆ›å»ºå®ä½“ DTO
 */
export interface CreateEntityDto {
	/** å®ä½“åç§° */
	name: string;
	/** å®ä½“çŠ¶æ€ */
	status?: string;
	/** æ‰€å±ç§Ÿæˆ· ID */
	tenantId: string;
}

/**
 * æ›´æ–°å®ä½“ DTO
 */
export interface UpdateEntityDto {
	/** å®ä½“åç§° */
	name?: string;
	/** å®ä½“çŠ¶æ€ */
	status?: string;
}

/**
 * æŸ¥è¯¢å®ä½“ DTO
 */
export interface QueryEntityDto {
	/** çŠ¶æ€ */
	status?: string;
	/** æœç´¢å…³é”®è¯ */
	search?: string;
}
```

### åˆ›å»º Service

åˆ›å»º `libs/<module-name>/src/lib/<module-name>.service.ts`ï¼š

```typescript
import { Injectable, NotFoundException, BadRequestException, Logger } from '@nestjs/common';
import { InjectRepository } from '@mikro-orm/nestjs';
import { EntityRepository, EntityManager } from '@mikro-orm/core';
import { EntityName, EntityStatus } from './entities/<entity-name>.entity';
import { CreateEntityDto, UpdateEntityDto, QueryEntityDto } from './dto/<entity-name>.dto';

@Injectable()
export class EntityNameService {
	private readonly logger = new Logger(EntityNameService.name);

	constructor(
		@InjectRepository(EntityName)
		private readonly entityRepo: EntityRepository<EntityName>
	) {}

	private get em(): EntityManager {
		return this.entityRepo.getEntityManager();
	}

	/**
	 * åˆ›å»ºæ–°å®ä½“
	 *
	 * @param data - å®ä½“åˆ›å»ºæ•°æ®
	 * @returns å·²åˆ›å»ºçš„å®ä½“
	 * @throws BadRequestException å¦‚æœå®ä½“åç§°å·²å­˜åœ¨
	 */
	async create(data: CreateEntityDto): Promise<EntityName> {
		// æ£€æŸ¥å®ä½“åç§°æ˜¯å¦å·²å­˜åœ¨
		const existing = await this.entityRepo.findOne({ name: data.name });
		if (existing) {
			throw new BadRequestException('å®ä½“åç§°å·²å­˜åœ¨');
		}

		// åˆ›å»ºæ–°å®ä½“å¹¶è®¾ç½®é»˜è®¤çŠ¶æ€
		const entity = this.entityRepo.create({
			...data,
			status: data.status ? EntityStatus[data.status] : EntityStatus.ACTIVE
		} as any);

		this.em.persist(entity);
		await this.em.flush();

		this.logger.log(`å·²åˆ›å»ºæ–°å®ä½“ï¼š${entity.id}`);
		return entity;
	}

	/**
	 * æŸ¥è¯¢å®ä½“åˆ—è¡¨
	 *
	 * @param query - æŸ¥è¯¢å‚æ•°
	 * @returns åŒ…å«å®ä½“åˆ—è¡¨å’Œæ€»æ•°çš„å“åº”
	 */
	async findAll(query: QueryEntityDto = {}): Promise<{ data: EntityName[]; total: number }> {
		const where: any = {};

		if (query.status) {
			where.status = EntityStatus[query.status];
		}

		if (query.search) {
			where.name = { $like: `%${query.search}%` };
		}

		const [data, total] = await this.entityRepo.findAndCount(where);

		return { data, total };
	}

	/**
	 * æ ¹æ® ID æŸ¥æ‰¾å®ä½“
	 *
	 * @param id - å®ä½“ ID
	 * @returns å®ä½“å®ä½“ï¼ˆå¦‚æœæ‰¾åˆ°ï¼‰ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸
	 * @throws NotFoundException å½“å®ä½“ä¸å­˜åœ¨æ—¶
	 */
	async findOne(id: string): Promise<EntityName> {
		const entity = await this.entityRepo.findOne({ id } as any);

		if (!entity) {
			throw new NotFoundException(`æœªæ‰¾åˆ° ID ä¸º ${id} çš„å®ä½“`);
		}

		return entity;
	}

	/**
	 * æ›´æ–°å®ä½“
	 *
	 * @param id - å®ä½“ ID
	 * @param data - æ›´æ–°æ•°æ®
	 * @returns å·²æ›´æ–°çš„å®ä½“
	 * @throws NotFoundException å½“å®ä½“ä¸å­˜åœ¨æ—¶
	 */
	async update(id: string, data: UpdateEntityDto): Promise<EntityName> {
		const entity = await this.findOne(id);

		Object.assign(entity, data);

		if (data.status) {
			entity.status = EntityStatus[data.status];
		}

		this.em.persist(entity);
		await this.em.flush();

		this.logger.log(`å·²æ›´æ–°å®ä½“ï¼š${entity.id}`);
		return entity;
	}

	/**
	 * åˆ é™¤å®ä½“ï¼ˆè½¯åˆ é™¤ï¼‰
	 *
	 * @param id - å®ä½“ ID
	 * @returns Promise<void> æ— è¿”å›å€¼
	 */
	async remove(id: string): Promise<void> {
		const entity = await this.findOne(id);

		this.em.remove(entity);
		await this.em.flush();

		this.logger.log(`å·²åˆ é™¤å®ä½“ï¼š${id}`);
	}
}
```

### åˆ›å»º Controller

åˆ›å»º `libs/<module-name>/src/lib/<module-name>.controller.ts`ï¼š

```typescript
import { Controller, Get, Post, Put, Delete, Body, Param, Query } from '@nestjs/common';
import { EntityNameService } from './<module-name>.service';
import { CreateEntityDto, UpdateEntityDto, QueryEntityDto } from './dto/<entity-name>.dto';

/**
 * å®ä½“æ§åˆ¶å™¨
 *
 * æä¾›å®ä½“çš„ HTTP API æ¥å£
 */
@Controller('entities')
export class EntityNameController {
	constructor(private readonly entityService: EntityNameService) {}

	/**
	 * åˆ›å»ºå®ä½“
	 *
	 * @param data - å®ä½“åˆ›å»ºæ•°æ®
	 * @returns å·²åˆ›å»ºçš„å®ä½“
	 */
	@Post()
	async create(@Body() data: CreateEntityDto): Promise<EntityName> {
		return await this.entityService.create(data);
	}

	/**
	 * æŸ¥è¯¢å®ä½“åˆ—è¡¨
	 *
	 * @param query - æŸ¥è¯¢å‚æ•°
	 * @returns åŒ…å«å®ä½“åˆ—è¡¨å’Œæ€»æ•°çš„å“åº”
	 */
	@Get()
	async findAll(@Query() query: QueryEntityDto): Promise<{ data: EntityName[]; total: number }> {
		return await this.entityService.findAll(query);
	}

	/**
	 * æ ¹æ® ID æŸ¥æ‰¾å®ä½“
	 *
	 * @param id - å®ä½“ ID
	 * @returns å®ä½“å®ä½“
	 */
	@Get(':id')
	async findOne(@Param('id') id: string): Promise<EntityName> {
		return await this.entityService.findOne(id);
	}

	/**
	 * æ›´æ–°å®ä½“
	 *
	 * @param id - å®ä½“ ID
	 * @param data - æ›´æ–°æ•°æ®
	 * @returns å·²æ›´æ–°çš„å®ä½“
	 */
	@Put(':id')
	async update(@Param('id') id: string, @Body() data: UpdateEntityDto): Promise<EntityName> {
		return await this.entityService.update(id, data);
	}

	/**
	 * åˆ é™¤å®ä½“
	 *
	 * @param id - å®ä½“ ID
	 * @returns æ— è¿”å›å€¼
	 */
	@Delete(':id')
	async remove(@Param('id') id: string): Promise<void> {
		return await this.entityService.remove(id);
	}
}
```

### åˆ›å»º Module

åˆ›å»º `libs/<module-name>/src/lib/<module-name>.module.ts`ï¼š

```typescript
import { Module } from '@nestjs/common';
import { MikroOrmModule } from '@mikro-orm/nestjs';
import { EntityNameService } from './<module-name>.service';
import { EntityNameController } from './<module-name>.controller';
import { EntityName } from './entities/<entity-name>.entity';

/**
 * å®ä½“æ¨¡å—
 *
 * æä¾›å®ä½“çš„åŠŸèƒ½æ¨¡å—
 */
@Module({
	imports: [MikroOrmModule.forFeature([EntityName])],
	providers: [EntityNameService],
	controllers: [EntityNameController],
	exports: [EntityNameService]
})
export class EntityNameModule {}
```

### åˆ›å»º Plugin

åˆ›å»º `libs/<module-name>/src/lib/<module-name>.plugin.ts`ï¼š

```typescript
import * as chalk from 'chalk';
import { IOksaisPluginBootstrap, IOksaisPluginDestroy } from '@oksai/plugin';

export class EntityNamePlugin implements IOksaisPluginBootstrap, IOksaisPluginDestroy {
	private logEnabled = true;

	async onPluginBootstrap(): Promise<void> {
		if (this.logEnabled) {
			console.log(chalk.green('âœ“ Entity Name Plugin initialized'));
		}
	}

	async onPluginDestroy(): Promise<void> {
		if (this.logEnabled) {
			console.log(chalk.red('âœ— Entity Name Plugin destroyed'));
		}
	}
}
```

### åœ¨ AppModule ä¸­æ³¨å†Œ

ç¼–è¾‘ `apps/base-api/src/app.module.ts`ï¼Œæ·»åŠ æ–°æ¨¡å—ï¼š

```typescript
import { Module } from '@nestjs/common';
import { EntityNameModule } from '@oksai/<module-name>';
import { EntityNamePlugin } from '@oksai/<module-name>';

@Module({
	imports: [
		// å…¶ä»–æ¨¡å—...
		EntityNameModule
	],
	providers: [
		// å…¶ä»–æ’ä»¶...
		EntityNamePlugin
	]
})
export class AppModule {}
```

---

## ä» backup å¤ç”¨ä»£ç æŒ‡å—

### å¦‚ä½•æŸ¥æ‰¾å‚è€ƒä»£ç 

åœ¨ `backup/` ç›®å½•ä¸­æŸ¥æ‰¾ç›¸å…³åŠŸèƒ½çš„å‚è€ƒä»£ç ï¼š

```bash
# æŸ¥æ‰¾ backup ä¸­çš„å®ä½“æ–‡ä»¶
find backup/ -name "*.entity.ts"

# æŸ¥æ‰¾ backup ä¸­çš„æœåŠ¡æ–‡ä»¶
find backup/ -name "*.service.ts"

# æŸ¥æ‰¾ backup ä¸­çš„æ§åˆ¶å™¨æ–‡ä»¶
find backup/ -name "*.controller.ts"
```

### å¦‚ä½•ç®€åŒ–æ—§ä»£ç 

ç®€åŒ–æ—§ä»£ç æ—¶ï¼Œåº”éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **ç§»é™¤ TypeORM ä»£ç ** - åªä¿ç•™ MikroORM ç›¸å…³ä»£ç 
2. **ç§»é™¤ ORM æŠ½è±¡å±‚** - ç›´æ¥ä½¿ç”¨ MikroORM
3. **ç®€åŒ–æ•°æ®åº“æ¨¡å‹** - ç§»é™¤ä¸å¿…è¦çš„å­—æ®µå’Œå…³è”
4. **éµå¾ªæ–°çš„ä»£ç è§„èŒƒ** - æŒ‰ç…§ [ä»£ç è§„èŒƒ](./CODING_STANDARDS.md) é‡æ„ä»£ç 
5. **æ·»åŠ å®Œæ•´çš„ TSDoc æ³¨é‡Š** - ä¸ºå…¬å…± API æ·»åŠ å®Œæ•´çš„ TSDoc æ³¨é‡Š

### æ³¨æ„äº‹é¡¹

**é‡è¦åŸåˆ™ï¼š**

-   **ä¸ä¿®æ”¹åŸåˆ™**ï¼šä¸æ”¹åŠ¨ `backup/` ç›®å½•çš„ä»£ç ç»“æ„å’Œä»£ç å†…å®¹ï¼ˆæ³¨é‡Šé™¤å¤–ï¼‰
-   **å‚è€ƒå¤ç”¨**ï¼šä¼˜å…ˆä½¿ç”¨å¯å¤ç”¨çš„æ—§ä»£ç ï¼Œé¿å…é‡å¤é€ è½®å­
-   **å¯¹é½ç»“æ„**ï¼šæ–°å¼€å‘çš„ä»£ç ç»„ç»‡ç»“æ„åº”å½“ä¿æŒä¸ `backup` ç›®å½•ä¸‹çš„æ—§é¡¹ç›®ä»£ç ç»„ç»‡ç»“æ„ä¸€è‡´

---

## å¼€å‘é…ç½®

### æ•°æ®åº“é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®æ•°æ®åº“è¿æ¥ï¼š

```bash
# æ•°æ®åº“ç±»å‹ï¼ˆpostgresã€mysqlã€sqliteï¼‰
DB_TYPE=postgres

# PostgreSQL é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_NAME=oksai_platform
DB_USER=postgres
DB_PASSWORD=your_password

# MySQL é…ç½®ï¼ˆå¤‡é€‰ï¼‰
# DB_TYPE=mysql
# DB_HOST=localhost
# DB_PORT=3306
# DB_NAME=oksai_platform
# DB_USER=root
# DB_PASSWORD=your_password

# SQLite é…ç½®ï¼ˆå¤‡é€‰ï¼‰
# DB_TYPE=sqlite
# DB_DATABASE=./data/oksai.db
```

### JWT é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½® JWTï¼š

```bash
# JWT è®¿é—®ä»¤ç‰Œå¯†é’¥ï¼ˆå¿…é¡»å®‰å…¨ï¼‰
JWT_ACCESS_SECRET=your_secure_random_string

# JWT åˆ·æ–°ä»¤ç‰Œå¯†é’¥ï¼ˆå¿…é¡»å®‰å…¨ï¼‰
JWT_REFRESH_SECRET=your_secure_random_string

# è®¿é—®ä»¤ç‰Œè¿‡æœŸæ—¶é—´
JWT_ACCESS_EXPIRES_IN=1d

# åˆ·æ–°ä»¤ç‰Œè¿‡æœŸæ—¶é—´
JWT_REFRESH_EXPIRES_IN=7d
```

### OAuth é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½® OAuthï¼š

```bash
# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=your_google_client_secret
ENABLE_GOOGLE_LOGIN=true

# GitHub OAuth
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret
ENABLE_GITHUB_LOGIN=true

# Microsoft OAuth
MICROSOFT_CLIENT_ID=your_microsoft_client_id
MICROSOFT_CLIENT_SECRET=your_microsoft_client_secret
MICROSOFT_AUTHORIZATION_URL=https://login.microsoftonline.com/common/oauth2/v2.0/authorize
MICROSOFT_TOKEN_URL=https://login.microsoftonline.com/common/oauth2/v2.0/token
ENABLE_MICROSOFT_LOGIN=true

# Auth0 OAuth
AUTH0_CLIENT_ID=your_auth0_client_id
AUTH0_CLIENT_SECRET=your_auth0_client_secret
AUTH0_DOMAIN=your_auth0_domain
ENABLE_AUTH0_LOGIN=true
```

### é‚®ä»¶é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®é‚®ä»¶ï¼š

```bash
# SMTP æœåŠ¡å™¨é…ç½®
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# é‚®ä»¶å‘ä»¶äººä¿¡æ¯
SMTP_FROM_NAME=OKSAI Platform
SMTP_FROM_EMAIL=noreply@oksai.io

# API é…ç½®
API_BASE_URL=http://localhost:3000
CLIENT_BASE_URL=http://localhost:4200
```

### Redis é…ç½®

åœ¨ `.env` æ–‡ä»¶ä¸­é…ç½® Redisï¼ˆç”¨äºé‚®ä»¶é˜Ÿåˆ—ï¼‰ï¼š

```bash
# Redis è¿æ¥é…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# é‚®ä»¶å‘Šè­¦é…ç½®
ADMIN_EMAIL=admin@oksai.io
```

---

## è°ƒè¯•æŠ€å·§

### VS Code è°ƒè¯•é…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.vscode/launch.json`ï¼š

```json
{
	"version": "0.2.0",
	"configurations": [
		{
			"type": "node",
			"request": "launch",
			"name": "Debug Base API",
			"program": "${workspaceFolder}/apps/base-api/dist/main.js",
			"preLaunchTask": "tsc: build - apps/base-api/tsconfig.app.json",
			"outFiles": ["${workspaceFolder}/apps/base-api/dist/**/*.js"],
			"runtimeArgs": ["--nolazy", "-r", "ts-node/register"],
			"sourceMaps": true,
			"cwd": "${workspaceFolder}",
			"console": "integratedTerminal",
			"internalConsoleOptions": "neverOpen"
		}
	]
}
```

### æ—¥å¿—è¾“å‡ºè§„èŒƒ

ä½¿ç”¨ NestJS Logger è®°å½•æ—¥å¿—ï¼Œæ—¥å¿—æ¶ˆæ¯ä½¿ç”¨ä¸­æ–‡ï¼š

```typescript
import { Logger } from '@nestjs/common';

@Injectable()
export class UserService {
	private readonly logger = new Logger(UserService.name);

	async create(data: CreateUserDto): Promise<User> {
		this.logger.debug(`æ­£åœ¨åˆ›å»ºç”¨æˆ·ï¼š${data.email}`);

		const user = this.userRepo.create(data);
		await this.em.persistAndFlush(user);

		this.logger.log(`å·²åˆ›å»ºæ–°ç”¨æˆ·ï¼š${user.id}`);
		return user;
	}
}
```

### å¸¸è§é”™è¯¯æ’æŸ¥

#### æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š** `Connection error: could not connect to database`

**è§£å†³æ–¹æ³•ï¼š**

1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®
2. ç¡®ä¿ PostgreSQL æœåŠ¡å·²å¯åŠ¨
3. æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

#### JWT ä»¤ç‰ŒéªŒè¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯ï¼š** `UnauthorizedException: æ— æ•ˆçš„ä»¤ç‰Œ`

**è§£å†³æ–¹æ³•ï¼š**

1. æ£€æŸ¥ JWT å¯†é’¥é…ç½®
2. æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
3. æ£€æŸ¥ä»¤ç‰Œæ ¼å¼æ˜¯å¦æ­£ç¡®

#### ä¾èµ–å†²çª

**é”™è¯¯ä¿¡æ¯ï¼š** `Error: Cannot find module 'xxx'`

**è§£å†³æ–¹æ³•ï¼š**

1. è¿è¡Œ `pnpm install` é‡æ–°å®‰è£…ä¾èµ–
2. æ£€æŸ¥ `package.json` ä¸­çš„ä¾èµ–ç‰ˆæœ¬
3. è¿è¡Œ `pnpm dedupe` è§£å†³ä¾èµ–å†²çª

---

## Git å·¥ä½œæµ

### åˆ†æ”¯ç­–ç•¥

```mermaid
gitGraph
    commit
    branch develop
    checkout develop
    commit
    branch feature/new-feature
    checkout feature/new-feature
    commit
    commit
    checkout develop
    merge feature/new-feature
    checkout main
    merge develop
```

**åˆ†æ”¯è¯´æ˜ï¼š**

-   **main** - ä¸»åˆ†æ”¯ï¼Œç”¨äºç”Ÿäº§ç¯å¢ƒ
-   **develop** - å¼€å‘åˆ†æ”¯ï¼Œç”¨äºé›†æˆæ–°åŠŸèƒ½
-   **feature/xxx** - åŠŸèƒ½åˆ†æ”¯ï¼Œç”¨äºå¼€å‘æ–°åŠŸèƒ½
-   **hotfix/xxx** - ä¿®å¤åˆ†æ”¯ï¼Œç”¨äºç´§æ€¥ä¿®å¤

### æäº¤ä¿¡æ¯è§„èŒƒ

Git æäº¤ä¿¡æ¯å¿…é¡»ä½¿ç”¨è‹±æ–‡æè¿°ï¼Œéµå¾ª Conventional Commits è§„èŒƒï¼š

```bash
# æ ¼å¼
<type>(<scope>): <subject>

# ç¤ºä¾‹
feat(auth): add Google OAuth login support
fix(tenant): fix tenant creation bug
docs(readme): update project description
style(core): fix code formatting
refactor(user): simplify user service logic
test(auth): add unit tests for auth service
chore(deps): update NestJS to version 11.1.12
```

**ç±»å‹è¯´æ˜ï¼š**

-   `feat` - æ–°åŠŸèƒ½
-   `fix` - ä¿®å¤ Bug
-   `docs` - æ–‡æ¡£æ›´æ–°
-   `style` - ä»£ç æ ¼å¼è°ƒæ•´
-   `refactor` - é‡æ„ä»£ç 
-   `test` - æµ‹è¯•ç›¸å…³
-   `chore` - æ„å»ºã€å·¥å…·ç›¸å…³

### ä»£ç å®¡æŸ¥æµç¨‹

1. **æäº¤ Pull Request** - æäº¤ PR åˆ° `develop` åˆ†æ”¯
2. **ä»£ç å®¡æŸ¥** - ç”±å…¶ä»–å¼€å‘è€…è¿›è¡Œä»£ç å®¡æŸ¥
3. **ä¿®æ”¹ä»£ç ** - æ ¹æ®å®¡æŸ¥æ„è§ä¿®æ”¹ä»£ç 
4. **åˆå¹¶ä»£ç ** - å®¡æŸ¥é€šè¿‡ååˆå¹¶ä»£ç 
5. **åˆ é™¤åˆ†æ”¯** - åˆ é™¤å·²åˆå¹¶çš„åŠŸèƒ½åˆ†æ”¯

---

## å¸¸è§é—®é¢˜

### å¼€å‘ç¯å¢ƒç›¸å…³

#### Q: å¦‚ä½•åˆ›å»ºæ–°çš„ @oksai/ åŒ…ï¼Ÿ

A: å‚è€ƒ [åˆ›å»ºæ–°æ¨¡å—æŒ‡å—](#åˆ›å»ºæ–°æ¨¡å—æŒ‡å—)ï¼Œåœ¨ `libs/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„åŒ…ç›®å½•ï¼Œå¹¶æŒ‰ç…§è§„èŒƒåˆ›å»ºå®ä½“ã€DTOã€Serviceã€Controllerã€Module å’Œ Pluginã€‚

#### Q: å¦‚ä½•ä» backup å¤ç”¨ä»£ç ï¼Ÿ

A: å‚è€ƒ [ä» backup å¤ç”¨ä»£ç æŒ‡å—](#ä»-backup-å¤ç”¨ä»£ç æŒ‡å—)ï¼Œåœ¨ `backup/` ç›®å½•ä¸­æŸ¥æ‰¾ç›¸å…³åŠŸèƒ½çš„å‚è€ƒä»£ç ï¼Œå¹¶æŒ‰ç…§æ–°çš„ä»£ç è§„èŒƒè¿›è¡Œç®€åŒ–ã€‚

#### Q: å¦‚ä½•è§£å†³ä¾èµ–å†²çªï¼Ÿ

A: è¿è¡Œ `pnpm install` é‡æ–°å®‰è£…ä¾èµ–ï¼Œæˆ–è¿è¡Œ `pnpm dedupe` è§£å†³ä¾èµ–å†²çªã€‚

### æ„å»ºå’Œéƒ¨ç½²ç›¸å…³

#### Q: å¦‚ä½•æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼Ÿ

A: è¿è¡Œ `pnpm run build:prod` æ„å»ºç”Ÿäº§ç‰ˆæœ¬ã€‚

#### Q: å¦‚ä½•é…ç½®ç”Ÿäº§ç¯å¢ƒï¼Ÿ

A: å‚è€ƒ [å¼€å‘é…ç½®](#å¼€å‘é…ç½®)ï¼Œåœ¨ `.env` æ–‡ä»¶ä¸­é…ç½®ç”Ÿäº§ç¯å¢ƒçš„å‚æ•°ã€‚

### æ•°æ®åº“ç›¸å…³

#### Q: å¦‚ä½•è¿›è¡Œæ•°æ®åº“è¿ç§»ï¼Ÿ

A: å‚è€ƒ [æ•°æ®åº“è¿ç§»å‘½ä»¤](#æ•°æ®åº“è¿ç§»å‘½ä»¤)ï¼Œä½¿ç”¨ `pnpm migration:generate` ç”Ÿæˆè¿ç§»ï¼Œä½¿ç”¨ `pnpm migration:run` è¿è¡Œè¿ç§»ã€‚

#### Q: å¦‚ä½•å›æ»šæ•°æ®åº“è¿ç§»ï¼Ÿ

A: è¿è¡Œ `pnpm migration:revert` å›æ»šæœ€åä¸€æ¬¡è¿ç§»ã€‚

---

## ç‰ˆæœ¬ä¿¡æ¯

-   **æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0.0
-   **æœ€åæ›´æ–°ï¼š** 2026-02-04
-   **ç»´æŠ¤è€…ï¼š** OKSAI å¹³å°å›¢é˜Ÿ
